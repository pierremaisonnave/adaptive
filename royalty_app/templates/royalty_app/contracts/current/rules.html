{% extends "royalty_app/layout.html" %}
{% block content %}



  <input hidden  id="count" type="number" value=0 >   
  <div class="top_row" >Contract Details </div>

  {% if contract.status == 'CURRENT' and user.role == 'WRITER' or  contract.status == 'CHANGE' and user.role in 'WRITER,VALIDATOR' %}
    <div class="horizontal-bar-contract">
      <div class="contract_icon" onclick="change_contract_tab(this,'validated')">
        <div  class="icon-circle" style="background-Color : red; color:red;border:solid 2px red">
          <span  class="bi bi-check"  style="font-size:30px;color:white"></span>  
        </div>
        <div style="text-align: center;">Validated</div>
      </div>
      {% if user.role == "WRITER" and contract.status == 'CURRENT'%}
        <div class="contract_icon" onclick="change_contract_tab(this,'writer')">
          <div  class="icon-circle" >
            <span  class="bi bi-pencil"  style="font-size:30px ;font-size:30px; "></span>  
          </div>
          <div style="text-align: center;">Writer</div>
        </div>
      {% endif%}
      {% if contract.status == 'CHANGE'%}
        <div class="contract_icon" onclick="change_contract_tab(this,'pending_validation')">
          <div  class="icon-circle">
            <span  class="bi bi-person-check-fill"  style="font-size:30px"></span>  
          </div>
          <div style="text-align: center;">To validate</div>
        </div>
      {% endif%}

    </div>
  {% endif%} 
    
    <!-------------------------------------------------------------------------------------> 
    <!---------------------------Validated Contract---- -----------------------------------> 
    <!-------------------------------------------------------------------------------------> 
      {% if contract.status in 'CURRENT,CHANGE' and user.role in 'READER,VALIDATOR,WRITER'  %}
        <div id="validated" class="contract_tab">
            <!---------------------------Basic info on contract -----------------------------------> 
              <div class="top_chevron_row" >
                <div class="top_chevron_bar">
                  <div class="top_chevron">
                    <span style="display: none;" class="bi bi-chevron-right chevron_unhide"onclick='unhide_dashboard()'></span>
                    <span  class="bi bi-chevron-down chevron_hide" onclick='hide_dashboard()'></span>
                  </div>
                  <div >

                  </div>
                  <div >
                    <span style="float: right;"></span>
                  </div>
                </div>

                <div  class="form_dashboard form_dashboard_fixed"  > 
                  <table>
                    <tr>
                      <td style="width:150px"> <!--type-->
                        <b>Contract Type:</b>
                      </td>
                      <td style="width:25vw; min-width:150px"> 
                        <span class="form_dashboard_content">{{contract_VALIDATED.contract_type}}</span>
                      </td>
                      <td style="width:160px"> <!--Currency-->
                        <b style=" margin-left:10px">Currency:</b>
                      </td>
                      <td>
                        <span class="form_dashboard_content">{{contract_VALIDATED.contract_currency}}</span>
                      </td>
                      <td style="display: none;"> <!-- Div via-->
                        <span class="form_dashboard_content" >{{ contract_VALIDATED.division_via.division_id }}</span>
                      </td>
                    </tr>
                    <tr>
                      <td > <!--Name-->
                        <b>Contract Name:</b>
                      </td>
                      <td > 
                        <span class="form_dashboard_content">{{contract_VALIDATED.contract_name}}</span>
                      </td>
                      <td > <!--periodicity-->
                        <b style=" margin-left:10px">Payment Periodicity:</b>
                      </td>
                      <td>
                        <span class="form_dashboard_content" >{{contract_VALIDATED.payment_periodicity.periodicity}}</span>  
                      </td>
                    </tr>
                    <tr>
                      <td > <!--Gald Div list-->
                        <b >Division:</b>
                      </td>
                      <td>
                          <span class="form_dashboard_content" >{{ contract_VALIDATED.division.division_id }}</span>
                      </td>

                      <td > <!--payment terms-->
                        <b style=" margin-left:10px">Payment terms (days):</b>
                      </td>
                      <td ><!--payment terms-->
                        <span class="form_dashboard_content" >{{contract_VALIDATED.payment_terms}}</span> 
                      </td>
                    </tr>
                    <tr>
                      <td > <!--pay/REC-->
                        <b>Pay/REC:</b>
                      </td>
                      <td >
                        <span class="form_dashboard_content" >{{ contract_VALIDATED.transaction_direction }}</span>
                      </td>
                      <td > <!--Brand list-->
                        <b style=" margin-left:10px">Brand:</b>
                      </td>
                      <td><!--Brand list-->
                        <span class="form_dashboard_content" >{{contract_VALIDATED.m3_brand.brand_name}}</span> 
                      </td>
                    </tr>

                  </table> 

                </div>
              </div>
            <!---------------------------Icon------------------------------------------------->
            <div class="horizontal-bar-contract">
              <div class="icon icon_all" onclick="change_tab('all')">
                <div  class="icon-circle" style="background-Color : red; color:red;border:solid 2px red">
                  <span  class="bi bi-eye-fill "  style="font-size:30px; color:white"></span>  
                </div>
                <div style="text-align: center;">All</div>
              </div>
              <div class="icon icon_rule" onclick="change_tab('rule')">
                <div  class="icon-circle">
                  <span  class="bi bi-journal-check "  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Rules</div>
              </div>
              <div class="icon icon_milestone" onclick="change_tab('milestone')">
                <div  class="icon-circle">
                  <span  class="bi bi-list-check "  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Milestones</div>
              </div>
              <div class="icon icon_beneficiary" onclick="change_tab('beneficiary')">
                <div  class="icon-circle">
                  <span  class="bi bi-people"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Partners</div>
              </div>
              <div class="icon icon_mini_guar" onclick="change_tab('mini_guar')">
                <div  class="icon-circle">
                  <span  class="bi bi-life-preserver"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Guarantee</div>
              </div>
              <div class="icon icon_attachement" onclick="change_tab('attachement')">
                <div  class="icon-circle">
                  <span  class="bi bi-paperclip"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">attachement</div>
              </div>
              <div class="icon icon_sales_breakdown" onclick="change_tab('sales_breakdown')">
                <div  class="icon-circle">
                  <span  class="bi bi-file-earmark-arrow-down"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">report</div>
              </div>
            </div>

          <div style="padding:20px 0px 0px 20px">
            <!----------------------------Rule table--------------------------------------> 
              {% if rule_list_VALIDATED %} 
                <div class="chevron" >
                  <span style="display: none;" class="bi bi-chevron-right" id="unhide_validated_rule" onclick='unhide_table("validated_rule")'></span>
                  <span  class="bi bi-chevron-down " id="hide_validated_rule" onclick='hide_table("validated_rule")'></span>
                  <h5 >Rules</h5>
                </div>
                <div id="validated_rule" class="content rule">
                  <!----------------------------SALES--------------------------------------> 
                    {% if rule_SALES_list_VALIDATED != 0 %}
                      {% if contract_VALIDATED.contract_type.name == "MARGIN_ADJ" %}
                        <span >SALES</span>
                      {% endif %}
                      <div  style="width:100% ;display: block" class="content rule">
                        <table  class="table table-striped table-sm"   style="width:100%">
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width:100px">Period from</th>
                              <th style="width:100px">Period to</th>
                              <th ></th>
                            </tr>
                          </thead>   
                          <tbody>
                            {% for rule in rule_list_VALIDATED %}
                              {% if rule.rule_type == 'SALES' %}
                                <tr> 
                                  <td > <!--Formulation  -->
                                    <span>  {{ rule.formulation.all|join:" ," }}</span>
                                  </td>
                    
                                  <td> <!--Country-->
                                    <span>
                                      {% if rule.country_incl_excl == "EXCLUDE" %}
                                        {% if rule.country_list != "---" %}All except : {% for country in rule.country.all %}{% if forloop.counter0 != 0 %}, {% endif %}{{country.country}}{% endfor %}
                                        {% else %}All
                                        {% endif %}
                                        {% else %}{% for country in rule.country.all %}{% if forloop.counter0 != 0 %}, {% endif %}{{country.country}}{% endfor %}
                                      {% endif %}
                                    </span>
                                  </td>           
                    
                                  <td><!--Date From-->
                                    <span>{{rule.period_from|date:"Y-m-d"}}</span>
                                  </td>
                        
                                  <td><!--Date To-->
                                    <span>{{rule.period_to|date:"Y-m-d"}}</span>
                                  </td>
                    
                                  <td ><!-- Delete Button-->
                                  </td>
                                </tr> 
                              {% endif %}   
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% endif %}
                  <!----------------------------COGS--------------------------------------> 
                    {% if rule_COGS_list_VALIDATED != 0 %}
                      {% if contract_VALIDATED.contract_type.name == "MARGIN_ADJ" %}
                        <span >COGS</span>
                      {% endif %}
                      <div  style="width:100% ;display: block" class="content rule" >
                        <table  class="table table-striped table-sm " style="width:100%">
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width:100px">Period from</th>
                              <th style="width:100px">Period to</th>
                              <th >COGS per unit</th>
                              <th ></th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for rule in rule_list_VALIDATED %}
                              {% if rule.rule_type == 'COGS' %}
                                <tr> 
                                  <td > <!--Formulation  -->
                                    <span>  {{ rule.formulation.all|join:" ," }}</span>
                                  </td>
                    
                                  <td> <!--Country-->
                                    <span>
                                      {% if rule.country_incl_excl == "EXCLUDE" %}All{% if rule.country_list != "---" %} except : {{ rule.country_list }}{% endif %}{% else %}{{ rule.country_list }}{% endif %}
                                    </span>
                                  </td>           
                    
                                  <td><!--Date From-->
                                    <span>{{rule.period_from|date:"Y-m-d"}}</span>
                                  </td>
                        
                                  <td><!--Date To-->
                                    <span>{{rule.period_to|date:"Y-m-d"}}</span>
                                  </td>
                                  <td {% if rule.tranche_type == 'YES' or rule.field_type == 'RATE' %} hidden {% endif  %} style="display:grid; grid-template-columns: auto auto"><!-- Qty amount-->
                                    <span>{{rule.qty_value|floatformat:"-3g"}} {{rule.qty_value_currency}}</span>
                                  </td>
                                  <td ><!-- Delete Button-->
                                  </td>
                                </tr>
                              {% endif %} 
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% endif %}
                  <!----------------------------ROYALTY--------------------------------------> 
                    {% if rule_ROYALTY_list_VALIDATED != 0 %}
                      {% if contract_VALIDATED.contract_type.name == "MARGIN_ADJ" %}
                        <span >ROYALTY</span>
                      {% endif %}
                      <div  style="width:100% ;display: block" class="content rule" >
                        <table  class="table table-striped table-sm  "  style="width:100%;">
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width: 100px">Period from</th>
                              <th style="width:100px">Period to</th>
                              <th>Royalty</th>
                              <th ></th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for rule in rule_list_VALIDATED %}
                              {% if rule.rule_type == 'ROYALTY' %}
                                <tr> 
                                  <td><span>{{rule.formulation.all|join:" ,"}}</span></td>
                                  <td> <!--Country-->
                                    <span>
                                      {% if rule.country_incl_excl == "EXCLUDE" %}All{% if rule.country_list != "---" %} except : {{ rule.country_list }}{% endif %}{% else %}{{ rule.country_list }}{% endif %}
                                    </span>
                                  </td>

                                  <td><!--Date From-->
                                    <span>{{rule.period_from|date:"Y-m-d"}}</span>
                                  </td>

                                  <td><!--Date To-->
                                    <span>{{rule.period_to|date:"Y-m-d"}}</span>
                                  </td>

                                  <td {% if rule.tranche_type == 'YES' or rule.field_type == 'QTY' %}hidden {% endif  %}><!-- Rate percentage-->
                                    <span>{{rule.rate_value|floatformat:2}}%</span>
                                  </td>

                                  <td {% if rule.tranche_type == 'NO' or rule.field_type == 'QTY' %}hidden {% endif  %}><!--table for tranches-->
                                    <table class="table table-striped " style="width: 320px;background-color:white">
                                      <thead>
                                        <tr>
                                          <th style="width:120px">from</th>
                                          <th style="width:120px">to ({{rule.tranche_currency}})</th>
                                          <th style="width:80px">rate</th>
                                          <th></th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {% for tranche in tranche_list_VALIDATED %}
                                          {% if tranche.rule == rule %}
                                          <tr>
                                            <td>{{tranche.from_amount|floatformat:"-3g"}}</td>
                                            <td >
                                              <span>{% if tranche.to_amount == 0 %}infinity{% else %}{{tranche.to_amount|floatformat:"-3g"}}{% endif %}</span>
                                            </td>
                                            <td>
                                              <span>{{tranche.percentage}}%</span>
                                            </td>
                                            <td></tr>
                                          {% endif %}
                                        {% endfor %}
                                      <tbody>
                                    </table>
                                  </td>

                                  <td {% if rule.tranche_type == 'YES' or rule.field_type == 'RATE' %} hidden {% endif  %} style="display:grid; grid-template-columns: auto auto"><!-- Qty amount-->
                                    <span>{{rule.qty_value|floatformat:"-3g"}} {{rule.qty_value_currency}} per unit sold</span>
                                  </td>
                                  
                                  <td {% if rule.tranche_type == 'NO' or rule.field_type == 'RATE' %}hidden {% endif  %}><!-- Tranche for qty : not available-->
                                    <span>functionality not activated</span>
                                  </td>

                                  <td></td><!-- Delete Button-->
                                  
                                </tr> 
                                {% endif %}       
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% endif %}
                  <!----------------------------MARGIN--------------------------------------> 
                  {% if rule_MARGIN_list_VALIDATED != 0 %}
                    {% if contract_VALIDATED.contract_type.name == "MARGIN_ADJ" %}
                      <span >MARGIN</span>
                    {% endif %}
                    <div  style="width:100% ;display: block" class="content rule">
                      <table  class="table table-striped table-sm  " style="width:100%">
                        <thead>
                          <tr >
                            <th style="width:15vw; min-width:150px">Formulation</th>
                            <th style="width:15vw; min-width:150px">Country</th>
                            <th style="width:100px">Period from</th>
                            <th style="width:100px">Period to</th>
                            <th >Margin</th>
                            <th ></th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for rule in rule_list_VALIDATED %}
                           {% if rule.rule_type == 'MARGIN' %}
                              <tr> 
                                <td> <!--Formulation-->
                                  <span>  {{ rule.formulation.all|join:" ," }}</span>
                                </td>
                                <td> <!--Country-->
                                  <span>
                                    {% if rule.country_incl_excl == "EXCLUDE" %}All{% if rule.country_list != "---" %} except : {{ rule.country_list }}{% endif %}{% else %}{{ rule.country_list }}{% endif %}
                                  </span>
                                </td>
                                <td><!--Date From-->
                                  <span>{{rule.period_from|date:"Y-m-d"}}</span>
                                </td>
                                <td><!--Date To-->
                                  <span>{{rule.period_to|date:"Y-m-d"}}</span>
                                </td>
                                <td {% if rule.tranche_type == 'YES' or rule.field_type == 'QTY' %}hidden {% endif  %}><!-- Rate percentage-->
                                  <span>{{rule.rate_value|floatformat:2}}%</span>
                                </td>
                                <td {% if rule.tranche_type == 'NO' or rule.field_type == 'QTY' %}hidden {% endif  %}><!--table for tranches-->
                                  <table class="table table-striped " style="width: 320px;background-color:white">
                                    <thead>
                                      <tr>
                                        <th style="width:120px">from</th>
                                        <th style="width:120px">to ({{rule.tranche_currency}})</th>
                                        <th style="width:80px">rate</th>
                                        <th></th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {% for tranche in tranche_list_VALIDATED %}
                                        {% if tranche.rule == rule %}
                                        <tr>
                                          <td>{{tranche.from_amount|floatformat:"-3g"}}</td>
                                          <td >
                                            <span>{% if tranche.to_amount == 0 %}infinity{% else %}{{tranche.to_amount|floatformat:"-3g"}}{% endif %}</span>
                                          </td>
                                          <td>
                                            <span>{{tranche.percentage}}%</span>
                                          </td>
                                          <td></td>
                                        </tr>
                                        {% endif %}
                                      {% endfor %}
                                    <tbody>
                                  </table>
                                </td>
                                <td ><!-- Delete Button-->
                                </td>
                              </tr> 
                            {% endif %}     
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
          
            <!----------------------------------Milestone payment-------------------------->
              {% if milestone_list_VALIDATED %}
                <div class="chevron" >
                  <span style="display: none;" class="bi bi-chevron-right" id="unhide_validated_milestone" onclick='unhide_table("validated_milestone")'></span>
                  <span  class="bi bi-chevron-down" id="hide_validated_milestone" onclick='hide_table("validated_milestone")'></span>
                  <h5 >Milestones</h5>
                </div>
                <div  style="width:100% ;display: block" class="content milestone" id="validated_milestone">
                  <table  class="table table-striped table-sm "  style="max-width: 1000px">
                    <thead>
                      <tr >
                        <th>Name</th>
                        <th>Amount</th>
                        <th>Booked</th>
                        <th>Market</th>
                        <th>Booking date</th>
                        <th>Payment date</th>
                        <th style=" height: 45px;"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for milestone in milestone_list_VALIDATED %}
                        <tr >
                          <td style="min-width:100px"><!--Name-->
                            <span style="width:100%;background-color: transparent;border-style: None;" >{{milestone.name}}</span>
                          </td>
                          <td style="min-width:100px"><!--Amount-->
                            <span  style="width:100%;background-color: transparent;border-style: None;" >{{milestone.amount|floatformat:"-3g"}}</span>
                            <span  style="width:100%;background-color: transparent;border-style: None;" >{{milestone.currency}}</span>
                          </td>
                          <td style="min-width:60px"><!--booked-->
                            <span  style="width:100%;background-color: transparent;border-style: None;" >{{milestone.booked}}</span>
                          </td>
                          <td  style="width:80px"><!--Market-->
                            <span {% if milestone.booked == "NO" %} hidden {% endif %} style=" background-color:transparent; border:None ;width:100%">{{milestone.market}}</span>
                          </td>
                          <td style="width:140px"><!--Booking date-->
                            <span {% if milestone.booked == "NO" %} hidden {% endif %} style=" background-color:transparent; border:None ;width:100%">{{milestone.booking_date|date:"Y-m-d"}}</span>
                          </td>
                          <td style="width:140px"><!--Payment date-->
                            <span {% if milestone.booked == "NO" %} hidden {% endif %} style=" background-color:transparent; border:None ;width:100%">{{milestone.payment_date|date:"Y-m-d"}}</span>
                          </td>
                          <td ><!--Button-->
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}


            <!----------------------------Beneficiary table-------------------------------->
              {% if contract_partner_list_VALIDATED %}
                <div class="chevron" >
                  <span style="display: none;" class="bi bi-chevron-right" id="unhide_validated_beneficiary" onclick='unhide_table("validated_beneficiary")'></span>
                  <span  class="bi bi-chevron-down" id="hide_validated_beneficiary" onclick='hide_table("validated_beneficiary")'></span>
                  <h5 >Beneficiaries</h5>
                </div>
                <div  style="width:100% ;display: block" class="content beneficiary" id="validated_beneficiary">
                  <table   class="table table-striped table-sm "  style="max-width: 500px">
                    <thead>
                      <tr >
                        <th > Name</th>
                        <th style="width: 80px">%</th>
                        <th style="width: 50px; ">
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for cp in contract_partner_list_VALIDATED %}
                        <tr >
                          <td ><!--Partner-->
                            <span>{{cp.partner.partner_name}}</span>
                          </td>
                          <td><!--percentage-->
                            <span>{{cp.percentage}} %</span>
                          </td>
                          <td ><!--Button-->
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            <!----------------------------------Mini_guar---------------------------------->

              {% if contract_VALIDATED.minimum_guar_amount != 0  %}
                <div class="chevron" >
                  <span style="display: none;" class="bi bi-chevron-right" id="unhide_validated_mini_guar" onclick='unhide_table("validated_mini_guar")'></span>
                  <span  class="bi bi-chevron-down" id="hide_validated_mini_guar" onclick='hide_table("validated_mini_guar")'></span>
                  <h5 >Minimum Guarantee</h5>
                </div>

                <div   class="content mini_guar" style="display: block" id="validated_mini_guar">
                  <div style=" display:grid;grid-template-columns: 320px 50px auto;margin-bottom:10px; width: 578px;">
                    <span>A minimum amount has to be paid/rec every year:</span>
                    <span>{{contract_VALIDATED.mini_gar_status}}</span>
                  </div>  

                  <table  class="table table-striped table-sm"  style="max-width: 500px  " id="mini_table" {% if 'NO' == contract.mini_gar_status  %} hidden {% endif %} id="head_table" >
                    <thead>
                      <tr  >
                        <th ><span>Amount</span></th>
                        <th><span>Country to allocate</span></th>
                        <th ><span>From</span></th>
                        <th ><span>To</span></th>
                      </tr>
                    </thead>
                    <tbody >
                      <tr >
                        <td ><!--Amount-->
                          <span>{{contract_VALIDATED.minimum_guar_amount|default_if_none:""|floatformat:"-3g"}} {{contract_VALIDATED.contract_currency}}</span>
                        </td>
                        <td ><!--Country-->
                          <span>{{contract_VALIDATED.minimum_guar_remaining_allocation_country.country_id}}</span>
                        </td>
                        <td><!--Date From-->
                          <span>{{ contract_VALIDATED.mini_gar_from }}</span>
                        </td>
                        <td><!--Date To-->
                          <span>{{ contract_VALIDATED.mini_gar_to }}</span>
                        </td>
                        <td></td>
                      </tr>
                    </tbody>
                  </table>
                </div>  
              {% endif %}
            <!----------------------------Contract saved in PDF---------------------------->
              {% if attachement_list_VALIDATED %}
              <div class="chevron" >
                <span style="display: none;" class="bi bi-chevron-right" id="unhide_validated_attachement" onclick='unhide_table("validated_attachement")'></span>
                <span  class="bi bi-chevron-down" id="hide_validated_attachement" onclick='hide_table("validated_attachement")'></span>
                <h5 >Supporting document(s)</h5>
              </div>
              <div  class="content attachement" style="display: block" id="validated_attachement" >
                <table  class="table table-striped table-sm "  style="max-width: 500px">
                  <tbody>
                    {% for a in attachement_list_VALIDATED %}
                      <tr >
                        <td ><!--File Name-->
                          <a href='{{a.upload.url}}' ><span class="fname"  >{{a.name}}</span></a>
                        </td>
                        <td ><!--Button-->
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
            <!----------------------------------Sales_breakdown_per_contract--------------->
              {% if sbd_contract_VALIDATED %}
                <div class="chevron" >
                  <span style="display: none;" class="bi bi-chevron-right" id="unhide_validated_sales_breakdown" onclick='unhide_table("validated_sales_breakdown")'></span>
                  <span  class="bi bi-chevron-down" id="hide_validated_sales_breakdown" onclick='hide_table("validated_sales_breakdown")'></span>
                  <h5 >Breakdown of sales in invoice reporting</h5>
                </div>
                <div  class="content sales_breakdown" style="display: block" id="validated_sales_breakdown"  >
                  <table  class="table table-striped table-sm"  style="max-width: 500px">
                    <thead>
                      <tr >
                        <th hidden></th>
                        <th>In import file</th>
                        <th>In contract report</th>
                        <th style="width: 30px">
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in sbd_VALIDATED %}
                        {% for sbd_contract in sbd_contract_VALIDATED%}
                          {% if sbd_contract.sales_breakdown_item == item %}
                            <tr> 
                              <td hidden>{{item.id}}</td>
                              <td >{{item.sales_breakdown_definition}}</td>
                              <td colspan="2" >
                                <span>
                                    {{sbd_contract.sales_breakdown_contract_definition}}
                                </span>
                              </td>
                            </tr>
                          {% endif %}
                        {% endfor %}
                      {% endfor%}
                    </tbody>
                  </table>
                </div>
              {% endif %}
          </div>  
        </div>
      {% endif %}
    <!-------------------------------------------------------------------------------------> 
    <!---------------------------Writer view--------------------------------------------> 
    <!-------------------------------------------------------------------------------------> 

      {% if contract.status in 'CURRENT,IN_CREATION' and user.role == "WRITER"  %}
        <span hidden  id="unique_row_number">10000</span>
        <div id="writer" class="contract_tab" {% if user.role == "WRITER" and contract.status == "CURRENT"  %}style="display: none;"{% endif%}>
          <!---------------------------Basic info on contract -----------------------------------> 
            <div class="top_chevron_row" >
              <div class="top_chevron_bar">
                <div class="top_chevron">
                  <span style="display: none;" class="bi bi-chevron-right chevron_unhide"  onclick='unhide_dashboard()'></span>
                  <span  class="bi bi-chevron-down chevron_hide"  onclick='hide_dashboard()'></span>
                </div>
                <div style="margin:auto 0px ;">
                  {% if contract.status == 'IN_CREATION'%}
                    Contract in creation : Not yet reviewed by validator(s)
                  {% endif%} 
                </div>
                <div >
                  <div style="float: right;" >
                    <div style="width:100px ;float: right;" id="button" class="comboTreeWrapper" >
                      <div  class="comboTreeInputWrapper" >
                        <button class="comboTreeInputBox" style="width:100px; margin:2px;background-color:transparent" >ACTION</button>
                      </div>
                      <div   class="comboTreeDropDownContainer action_button" id="dropdown_contract" >
                        {% if contract.status == 'IN_CREATION'  %}
                          <li style="display: block; padding-left:0px; margin:2px"    >
                            <button   class="approve_button" onclick='save_contract({{contract.id}},"SAVE_FOR_LATER")'>Save for later</button>
                          </li>
                          <li style="display: block; padding-left:0px; margin:2px"  >
                            <button class="approve_button" onclick='save_contract({{contract.id}},"SUBMIT_NEW")'>Submit change to validator</button>
                          </li>
                          <li style="display: block; padding-left:0px; margin:2px"  >
                            <button class="reject_button" onclick='delete_contract("{% url 'delete_contract' contract_id=contract.id %}")'>Delete contract</button>
                          </li>
                        {% elif contract.status == 'CURRENT' %}
                        <li style="display: block; padding-left:0px; margin:2px"  >
                          <button class="approve_button" onclick='save_contract({{contract.id}},"SUBMIT_CHANGE")'>Submit change to validator</button>
                        </li>
                        <li style="display: block; padding-left:0px; margin:2px"  >
                          <button onclick='submit_delete_contract_request({{contract.id}})'  class="reject_button" >Submit delete to validator</button>
                        </li>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <form   class="form_dashboard" > 
                <table>
                  <tr>
                    <td style="width:150px"> <!--type-->
                      <span><b>Contract Type:</b></span>
                    </td>
                    <td style="width:25vw; min-width:150px"> 
                      <input  hidden id="contract_type"  value='{{contract_WRITER.contract_type.id}}'>
                      <input disabled type="text" placeholder="Contract Type"  maxlength="50" class="form_dashboard_content_writer"   value='{{contract_WRITER.contract_type.name}}'>
                    </td>
                    <td style="width:160px"> <!--Currency-->
                      <span style=" margin-left:10px"><b>Currency:</b></span>
                    </td>
                    <td>
                      <input  id="contract_currency" class="form_dashboard_content_writer"   value='{{contract_WRITER.contract_currency}}' disabled>
                    </td>
                  </tr>
                  <td style="display: none;"> <!-- Div via-->
                    <select  id="division_via" class="form_dashboard_content_writer_droppdown" style="padding:2px">
                      {% for division in division_list %}
                        {% if division == contract_WRITER.division_via  %}
                          <option value="{{ division.division_id }}" selected="selected">{{ division.division_id }}:{{ division.division_name }}</option>
                        {% else%}
                        <option value="{{ division.division_id }}" >{{ division.division_id }}:{{ division.division_name }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                  </td>
                  <tr>
                    <td > <!--Name-->
                      <span><b>Contract Name:</b></span>
                    </td>
                    <td > 
                      <input type="text" id="contract_name" placeholder="Contract Name"  maxlength="50" class="form_dashboard_content_writer"   value='{{contract_WRITER.contract_name}}'>
                    </td>
                    <td > <!--periodicity-->
                      <span style=" margin-left:10px"><b>Payment Periodicity:</b></span>
                    </td>
                    <td>
                        <select id="payment_periodicity" class="form_dashboard_content_writer_droppdown"  >
                          {% for periodicity in periodicity_list %}
                            {% if periodicity == contract_WRITER.payment_periodicity  %}
                              <option value="{{ periodicity.id }}" selected="selected">{{ periodicity.periodicity }}</option>
                            {% else%}
                              <option value="{{ periodicity.id }}" >{{ periodicity.periodicity }}</option>
                            {% endif %}
                          {% endfor %}
                        </select>
              
                    </td>
                  </tr>
                  <tr>
                    <td> <!--Gald Div list-->
                      <span ><b>Division:</b></span>
                    </td>
                    <td>
            
                        <select  id="division"  class="form_dashboard_content_writer_droppdown"  >
                          {% for division in division_list %}
                            {% if division == contract_WRITER.division  %}
                              <option value="{{ division.division_id }}" selected="selected">{{ division.division_id }}:{{ division.division_name }}</option>
                            {% else%}
                            <option value="{{ division.division_id }}" >{{ division.division_id }}:{{ division.division_name }}</option>
                            {% endif %}
                          {% endfor %}
                        </select>
                    </td>
                    <td > <!--payment terms-->
                      <span style=" margin-left:10px"><b>Payment terms (days):</b></span>
                    </td>
                    <td >
                      <input id="payment_terms" placeholder="nb days-payment terms"  type="number" min="0"  class="form_dashboard_content_writer"  value="{{contract_WRITER.payment_terms}}">
                    </td>
                  </tr>
                  <tr>
                    <td > <!--pay/REC-->
                      <span><b>Pay/REC:</b></span>
                    </td>
                    <td >
                      <input  id="transaction_direction" class="form_dashboard_content_writer"   value='{{contract_WRITER.transaction_direction}}' disabled>
            
                    </td>
                    <td > <!--Brand list-->
                      <span style=" margin-left:10px"><b>Brand:</b></span>
                    </td>
                    <td>
                      <select  id="brand" class="form_dashboard_content_writer_droppdown"  >
                        {% for brand in brand_list %}
                          {% if brand == contract_WRITER.m3_brand  %}
                            <option value="{{ brand.id }}" selected="selected">{{ brand.brand_name }}</option>
                          {% else%}
                            <option value="{{ brand.id }}">{{ brand.brand_name }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </td>
                  </tr>
            
                </table> 
            
              </form>
            </div>
          <!---------------------------Icon-----------------------------------------------overflow-x: auto;padding-bottom:250px-->
            <div class="horizontal-bar-contract">
              <div class="icon icon_all" onclick="change_tab('all')">
                <div  class="icon-circle" style="background-Color : red; color:red;border:solid 2px red">
                  <span  class="bi bi-eye-fill "  style="font-size:30px; color:white"></span>  
                </div>
                <div style="text-align: center;">All</div>
              </div>
              <div class="icon icon_rule" onclick="change_tab('rule')">
                <div  class="icon-circle">
                  <span  class="bi bi-journal-check "  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Rules</div>
              </div>
              <div class="icon icon_milestone" onclick="change_tab('milestone')">
                <div  class="icon-circle">
                  <span  class="bi bi-list-check "  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Milestones</div>
              </div>
              <div class="icon icon_beneficiary" onclick="change_tab('beneficiary')">
                <div  class="icon-circle">
                  <span  class="bi bi-people"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Partners</div>
              </div>
              <div class="icon icon_mini_guar" onclick="change_tab('mini_guar')">
                <div  class="icon-circle">
                  <span  class="bi bi-life-preserver"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Guarantee</div>
              </div>
              <div class="icon icon_attachement" onclick="change_tab('attachement')">
                <div  class="icon-circle">
                  <span  class="bi bi-paperclip"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">attachement</div>
              </div>
              <div class="icon icon_sales_breakdown" onclick="change_tab('sales_breakdown')">
                <div  class="icon-circle">
                  <span  class="bi bi-file-earmark-arrow-down"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">report</div>
              </div>
            </div>
            <div style="padding:20px 0px 0px 20px; ">
            <!-------------------------------------Rule table--------------------------->  
              <div class="chevron" >
                <span style="display: none;" class="bi bi-chevron-right" id="unhide_WRITER_rule" onclick='unhide_table("WRITER_rule")'></span>
                <span  class="bi bi-chevron-down " id="hide_WRITER_rule" onclick='hide_table("WRITER_rule")'></span>
                <h5 >Rules</h5>
              </div>
              <div id="WRITER_rule" class="content rule">
                <!----------------------------SALES--------------------------------------> 
                  {% if contract_WRITER.contract_type.name == "MARGIN_ADJ" %}
                    {% with rule_type="SALES" %}
                      <span >SALES</span>   
                      <div class="content rule"> 
                        <table style="width:100%" class="table table-striped table-sm " id="writer_{{rule_type}}" >
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width: 125px;padding: 4.8px 0px">Period from</th>
                              <th style="width: 125px;padding: 4.8px 0px">Period to</th>
                              <th ></th>
                            </tr>
                          </thead>
                          <tbody class="tbody_writer">
                            {% for rule in rule_list_WRITER %}
                              {% if rule.rule_type == rule_type %}
                                <tr> 
                                  <td > <!--Formulation  -->
                                    <div onclick="import_form_list(this)"  class="comboTreeWrapper ">
                                      <div  class="comboTreeInputWrapper formulation" >
                                        <div  style="width: 100%"  class="justAnInputBox comboTreeInputBox "  >
                                          {% for form in rule.formulation.all %}{% if forloop.counter0 != 0 %}, {% endif %}{{form.formula_name}}{% endfor %}
                                        </div>
                                        <input  class="comboTreeHiddenBox"  value='{{ rule.formulation.all|join:", " }}'  type="text" hidden  > 
                                        <input  hidden  class="selection_mode_input " value="INCLUDE">
                                      </div>
                                    </div>
                                  </td>
                                  <td> <!--Country-->
                                    <div  onclick="import_country_list(this)" class="comboTreeWrapper ">
                                      <div  class="comboTreeInputWrapper country" >
                                          <div  style="background-color:transparent; border-style: None "  class="justAnInputBox comboTreeInputBox " 
                                          >{% if rule.country_incl_excl == "EXCLUDE" %}
                                            {% if rule.country_list != "---" %}All except : {% for country in rule.country.all %}{% if forloop.counter0 != 0 %}, {% endif %}{{country.country}}{% endfor %}
                                            {% else %}All{% endif %}
                                          {% else %}{% for country in rule.country.all %}{% if forloop.counter0 != 0 %}, {% endif %}{{country.country}}{% endfor %}
                                          {% endif %}</div >
                                        <input  hidden  class="comboTreeHiddenBox " 
                                          {% if rule.country_list == "---" %}
                                            value=''
                                          {% else %} 
                                            value='{{rule.country_list}}' 
                                          {% endif %} type="text"    > 
                                        <input   hidden class="selection_mode_input " value="{{rule.country_incl_excl}}">
                                      </div>
                                    </div>
                                  </td>
                                  <td style="padding: 4.8px 0px"><!--Date From-->
                                    <input class="period_from" style="background-color:transparent; border-style: None;width:125px " min="1900-01-01" max="2200-12-31" type="date" value={{rule.period_from|date:"Y-m-d"}}>
                                  </td>
                                  <td style="padding: 4.8px 0px"><!--Date To-->
                                    <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31"type="date" value={{rule.period_to|date:"Y-m-d"}}>
                                  </td>
                                  <td ><!-- Delete Button-->
                                    <button  class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                                  </td>
                                </tr>         
                              {% endif %}
                            {% endfor %}
                            <tr> <!--empty New row-->
                              <td onchange="add_new_row(this,'{{rule_type}}')"> <!--Formulation-->
                                <div  onclick="import_form_list(this)" class="comboTreeWrapper " >
                                    <div  class="comboTreeInputWrapper formulation" >
                                      <div style="width: 100%;color:grey "   class="justAnInputBox comboTreeInputBox "  >Select</div>
                                      <input  class="comboTreeHiddenBox "  type="text" hidden   > 
                                      <input  hidden  class="selection_mode_input " value="INCLUDE">
                                    </div>
                                  </div>
                              </td>
                              <td> <!--Country-->
                                <div onclick="import_country_list(this)" class="comboTreeWrapper ">
                                  <div  class="comboTreeInputWrapper country" >
                                    <div    style="width: 100%;color:grey "   class="justAnInputBox comboTreeInputBox " >Select</div>
                                    <input  class="comboTreeHiddenBox " type="text" hidden  id="item_list_ctry_{{rule_type}}10000" > 
                                    <input hidden   class="selection_mode_input " value="INCLUDE">
                                  </div>
                                </div>
                              </td>
                              <td style="padding: 4.8px 0px"><!--Date From-->
                                <input class="period_from" style="background-color:transparent; border-style: None;width:125px;  "  min="1900-01-01" max="2200-12-31" type="date" value="1900-01-01">
                              </td>
                              <td style="padding: 4.8px 0px"><!--Date To-->
                                <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31" type="date" value="2200-12-31">
                              </td>
                              <td ><!-- Delete Button-->
                                <button   hidden class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                              </td>
                            </tr>
                          </tbody>
                
                        </table>
                      </div> 
                      <!-- new Rule: when the user change the value of the last row (formulation cell), we automatically enter a new row-->
                      <table hidden>
                        <tbody id="hidden_row_{{rule_type}}"> 
                          <tr>
                            <td onchange="add_new_row(this,'{{rule_type}}')" ><!--Formulation  -->
                              <div  class="comboTreeWrapper ">
                                  <div  class="comboTreeInputWrapper formulation" >
                                    <div  style="width:100%;color:grey "  class="justAnInputBox comboTreeInputBox "   >Select</div>
                                    <input   class="comboTreeHiddenBox " type="text" hidden   > 
                                    <input   hidden class="selection_mode_input " value="INCLUDE">
                                  </div>
                                  <div  class="comboTreeDropDownContainer" style="display: none;">
                                    <input  type="text" class="multiplesFilter" style="width:100%" placeholder="Type to filter" >
                                      <ul  >
                                        <li class="selection_mode" >
                                          <input hidden type="checkbox" class="select_all_box"   style="margin-right:5px;"value="Select all exept:">Select all exept
                                        </li>
                                        {% for formulation in formulation_list %}
                                          <li   style="display: block;">
                                            <input type="checkbox" style="margin-right:5px;"  item_code="{{formulation.formula_code}}" item_display="{{formulation.formula_name}}" >
                                            <span>{{formulation.formula_code}} : {{formulation.formula_name}}</span>
                                          </li>
                                        {% endfor %}
                                      </ul>
                                  </div>
                                </div>
                            </td>
                            <td><!--Country-->
                              <div  class="comboTreeWrapper ">
                                <div  class="comboTreeInputWrapper country" >
                                  <div style="width:100%;color:grey "  class="justAnInputBox comboTreeInputBox "  >Select</div>
                                  <input  class="comboTreeHiddenBox "  type="text" hidden  > 
                                  <input   hidden class="selection_mode_input " value="INCLUDE">
                                </div>
                                <div  class="comboTreeDropDownContainer"  style="display: none;">
                                  <input  type="text" class="multiplesFilter" style="width:100%" placeholder="Type to filter">
                                    <ul  >
                                      <li class="selection_mode" >
                                          <input type="checkbox" class="select_all_box"  style="margin-right:5px;"  value="Select all exept:">Select all exept
                                      </li>
                                      {% for region in region_list %}
                                        <li>
                                          <span class="bi bi-chevron-down comboTreeParentPlus"  ></span>
                                          <span class="group" >{{region.region}}</span>
                                          <ul style="display: block;" >
                                            {% for country in country_list %}
                                              {% if country.country_region == region %}
                                              <li   style="display: block;">
                                                <input type="checkbox" style="margin-right:5px;" item_code="{{country.country_id}}" item_display="{{country.country}}"  >
                                                <span>{{country.country_id}}: {{country.country}}</span>
                                              </li>
                                              {% endif  %}
                                            {% endfor %}
                                          </ul>
                                        </li>
                                      {% endfor %}
                                    </ul>
                                </div>
                              </div>
                            </td>
                            <td style="padding: 4.8px 0px"><!--Date From-->
                              <input class="period_from" style="background-color:transparent; border-style: None;width:125px" min="1900-01-01" max="2200-12-31" type="date" value="1900-01-01">
                            </td>
                            <td style="padding: 4.8px 0px"><!--Date To-->
                              <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31" type="date" value="2100-01-01">
                            </td>
                            <td ><!-- Delete Button-->
                              <button hidden   class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                            </td>
                          <tr>
                        </tbody>
                      </table>
                    {% endwith %}
                  {% endif %}
                <!----------------------------COGS----------------------------------------> 
                  {% if contract_WRITER.contract_type.name == "MARGIN_ADJ" %}
                    {% with rule_type="COGS" %}
                      <span >COGS</span>   
                      
                      <div class="content rule"> 
                        <table style="width:100%" class="table table-striped table-sm " id="writer_COGS" >
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width: 125px;padding: 4.8px 0px">Period from</th>
                              <th style="width: 125px;padding: 4.8px 0px">Period to</th>
                              <th style="width: 140px" >COGS per unit</th>
                              <th ></th>
                            </tr>
                          </thead>
                          
                          <tbody class="tbody_writer">
                            {% for rule in rule_list_WRITER %}
                              {% if rule.rule_type == rule_type %}
                                <tr> 
                                  <td > <!--Formulation  -->
                                    <div onclick="import_form_list(this)" class="comboTreeWrapper" >
                                        <div  class="comboTreeInputWrapper formulation" >
                                          <div  style="width: 100%"  class="justAnInputBox comboTreeInputBox  "  >
                                            {% for form in rule.formulation.all %}{% if forloop.counter0 != 0 %}, {% endif %}{{form.formula_name}}{% endfor %}
                                          </div>
                                          <input class="comboTreeHiddenBox " value='{{ rule.formulation.all|join:", " }}'  type="text" hidden   > 
                                          <input  hidden  class="selection_mode_input " value="INCLUDE">
                                        </div>
                                      </div>
                                  </td>
                                  <td> <!--Country-->
                                    <div  onclick="import_country_list(this)" class="comboTreeWrapper ">
                                      <div  class="comboTreeInputWrapper country" >
                                          <div  style="background-color:transparent; border-style: None "  class="justAnInputBox comboTreeInputBox " 
                                          >{% if rule.country_incl_excl == "EXCLUDE" %}{% if rule.country_list != "---" %}All except : {{ rule.country_list}}{% else %}All{% endif %}{% else %}{{ rule.country_list }}{% endif %}</div >
                                        <input class="comboTreeHiddenBox "    
                                          {% if rule.country_list == "---" %}
                                            value=''
                                          {% else %} 
                                            value='{{rule.country_list}}' 
                                          {% endif %} type="text" hidden   > 
                                          <input  hidden class="selection_mode_input " value="{{rule.country_incl_excl}}">
                                        </div>
                                    </div>
                                  </td>
                                  <td style="padding: 4.8px 0px"><!--Date From-->
                                    <input class="period_from" style="background-color:transparent; border-style: None;width:125px " min="1900-01-01" max="2200-12-31" type="date" value={{rule.period_from|date:"Y-m-d"}}>
                                  </td>
                                  <td style="padding: 4.8px 0px"><!--Date To-->
                                    <input  class="period_to"  style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31"type="date" value={{rule.period_to|date:"Y-m-d"}}>
                                  </td>
                                  <td > <!--COGS per unit-->
                                    <div  style="display:flex">
                                      <input class="number-separator qty_value" style="max-width:80px;background-color: transparent;border-style: None;" placeholder="price per unit"  type="text" value={{rule.qty_value|floatformat:"-3g"}}>
                                      <!--<input  style="width:60px ;background-color: transparent;border-style: None" onclick="import_qty_value_currency(this)" value={{rule.qty_value_currency}}  >-->
                                      <select class ="qty_value_currency" style=" background-color:transparent; border:None ;width:60px">
                                        {% for curr in currency_list %}
                                          {% if rule.qty_value_currency == curr %}
                                            <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                          {% else %}
                                            <option value={{curr.currency}}>{{curr.currency}}</option>          
                                          {% endif %}
                                        {% endfor %}
                                      </select>
                                    </div>
                                  </td>
                                  <td ><!-- Delete Button-->
                                    <button  class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                                  </td>
                                </tr>         
                              {% endif %}
                            {% endfor %}
                            <tr> <!--empty New row-->
                              <td onchange="add_new_row(this,'{{rule_type}}')"> <!--Formulation-->
                                <div  onclick="import_form_list(this)" class="comboTreeWrapper" >
                                    <div  class="comboTreeInputWrapper formulation">
                                      <div style="width: 100%;color:grey "   class="justAnInputBox comboTreeInputBox "  >Select</div>
                                      <input class="comboTreeHiddenBox "  type="text" hidden  > 
                                      <input  hidden  class="selection_mode_input " value="INCLUDE">
                                    </div>
                                  </div>
                              </td>
                              <td> <!--Country-->
                                <div onclick="import_country_list(this)" class="comboTreeWrapper ">
                                  <div  class="comboTreeInputWrapper country">
                                    <div style="width: 100%;color:grey"    class="justAnInputBox comboTreeInputBox "  >Select</div>
                                    <input class="comboTreeHiddenBox "type="text" hidden   > 
                                    <input  hidden  class="selection_mode_input " value="INCLUDE">
                                  </div>
                                </div>
                              </td>
                              <td style="padding: 4.8px 0px"><!--Date From-->
                                <input  class="period_from" style="background-color:transparent; border-style: None;width:125px;  "  min="1900-01-01" max="2200-12-31" type="date" value="1900-01-01">
                              </td>
                              <td style="padding: 4.8px 0px"><!--Date To-->
                                <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31" type="date" value="2200-12-31">
                              </td>
                              <td ><!--COGS per unit-->
                                <div   style="display:flex"><!-- Qty amount-->
                                  <input class="number-separator qty_value" style="max-width:80px;background-color: transparent;border-style: None;" placeholder="price per unit"  type="text">
                                  <select style=" background-color:transparent; border:None ;width:60px" class="qty_value_currency">
                                    {% for curr in currency_list %}
                                      {% if contract.contract_currency == curr %}
                                        <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                      {% else %}
                                        <option value={{curr.currency}}>{{curr.currency}}</option>          
                                      {% endif %}
                                    {% endfor %}
                                  </select>
                                </div>
                              </td>
                              <td ><!-- Delete Button-->
                                <button   hidden class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                              </td>
                            </tr>
                          </tbody>
                
                        </table>
                      </div> 
                      <!-- new Rule: when the user change the value of the last row (formulation cell), we automatically enter a new row-->
                      <table hidden>
                        <tbody id="hidden_row_{{rule_type}}"> 
                          <tr>
                            <td onchange="add_new_row(this,'{{rule_type}}')" ><!--Formulation  -->
                              <div  class="comboTreeWrapper">
                                  <div  class="comboTreeInputWrapper formulation" >
                                    <div style="width:100%;color:grey "  class="justAnInputBox comboTreeInputBox "  >Select</div>
                                    <input  class="comboTreeHiddenBox "  type="text" hidden  > 
                                    <input  hidden  class="selection_mode_input " value="INCLUDE">
                                  </div>
                                  <div  class="comboTreeDropDownContainer"  style="display: none;">
                                    <input  type="text" class="multiplesFilter" style="width:100%" placeholder="Type to filter" >
                                      <ul  >
                                        <li class="selection_mode" >
                                          <input hidden type="checkbox" class="select_all_box"   style="margin-right:5px;" value="Select all exept:">Select all exept
                                        </li>
                                        {% for formulation in formulation_list %}
                                          <li   style="display: block;">
                                            <input type="checkbox" style="margin-right:5px;"  item_code="{{formulation.formula_code}}" item_display="{{formulation.formula_name}}" >
                                            <span>{{formulation.formula_code}} : {{formulation.formula_name}}</span>
                                          </li>
                                        {% endfor %}
                                      </ul>
                                  </div>
                                </div>
                            </td>
                            <td><!--Country-->
                              <div  class="comboTreeWrapper ">
                                <div  class="comboTreeInputWrapper country" >
                                  <div style="width:100%;color:grey "  class="justAnInputBox comboTreeInputBox " >Select</div>
                                  <input   class="comboTreeHiddenBox "  type="text" hidden  > 
                                  <input  hidden  class="selection_mode_input " value="INCLUDE">
                                </div>
                                <div  class="comboTreeDropDownContainer"  style="display: none;">
                                  <input  type="text" class="multiplesFilter" style="width:100%" placeholder="Type to filter" >
                                    <ul  >
                                      <li class="selection_mode" >
                                        <input type="checkbox" class="select_all_box"   style="margin-right:5px;"  value="Select all exept:">Select all exept
                                      </li>
                                      {% for region in region_list %}
                                        <li>
                                          <span class="bi bi-chevron-down comboTreeParentPlus" ></span>
                                          <span class="group" >{{region.region}}</span>
                                          <ul style="display: block;" >
                                            {% for country in country_list %}
                                              {% if country.country_region == region %}
                                              <li   style="display: block;">
                                                <input type="checkbox" style="margin-right:5px;"  item_code="{{country.country_id}}" item_display="{{country.country}}" >
                                                <span>{{country.country_id}} : {{country.country}}</span>
                                              </li>
                                              {% endif  %}
                                            {% endfor %}
                                          </ul>
                                        </li>
                                      {% endfor %}
                                    </ul>
                                </div>
                              </div>
                            </td>
                            <td style="padding: 4.8px 0px"><!--Date From-->
                              <input class="period_from" style="background-color:transparent; border-style: None;width:125px" min="1900-01-01" max="2200-12-31" type="date" value="1900-01-01">
                            </td>
                            <td style="padding: 4.8px 0px"><!--Date To-->
                              <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31" type="date" value="2100-01-01">
                            </td>
                            <td> <!--royalty rules-->
                              <div   style="display:flex"><!--Qty-->
                                <input class="number-separator qty_value" style="width:80px;background-color: transparent;border-style: None;" placeholder="price per unit"  type="text">
                                <select style=" background-color:transparent; border:None ;width:60px" class="qty_value_currency">
                                  {% for curr in currency_list %}
                                    {% if contract.contract_currency == curr %}
                                      <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                    {% else %}
                                      <option value={{curr.currency}}>{{curr.currency}}</option>          
                                    {% endif %}
                                  {% endfor %}
                                </select>
                
                              </div>
                            </td>
                            <td ><!-- Delete Button-->
                              <button hidden   class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                            </td>
                          <tr>
                        </tbody>
                      </table>
                    {% endwith %}
                  {% endif %}
                <!----------------------------ROYALTY--------------------------------------> 

                  {% with rule_type="ROYALTY" %}
                    {% if contract_WRITER.contract_type.name == "MARGIN_ADJ" %}
                      <span >{{rule_type}}</span>
                    {% endif %}
                    <div class="content rule"> 
                      <table style="width:100%" class="table table-striped table-sm " id="writer_{{rule_type}}" >
                        <thead>
                          <tr >
                            <th style="width:15vw; min-width:150px">Formulation</th>
                            <th style="width:15vw; min-width:150px">Country</th>
                            <th style="width: 125px;padding: 4.8px 0px">Period from</th>
                            <th style="width: 125px;padding: 4.8px 0px">Period to</th>
                            <th style="width: 53px;padding: 4.8px 0px">Type</th>
                            <th style="width: 53px;padding: 4.8px 0px">Tranche</th>
                            <th style="width: 70px" >Royalty</th>
                            <th ></th>
                          </tr>
                        </thead>
                        
                        <tbody class="tbody_writer">
                          {% for rule in rule_list_WRITER %}
                            {% if rule.rule_type == rule_type %}
                              <tr> 
                                <td > <!--Formulation  -->
                                  <div onclick="import_form_list(this)" class="comboTreeWrapper" >
                                      <div  class="comboTreeInputWrapper formulation" >
                                        <div  style="width: 100%"  class="justAnInputBox comboTreeInputBox "   >
                                          {% for form in rule.formulation.all %}{% if forloop.counter0 != 0 %}, {% endif %}{{form.formula_name}}{% endfor %}
                                        </div>
                                        <input   class="comboTreeHiddenBox " value='{{ rule.formulation.all|join:", " }}'  type="text" hidden   > 
                                        <input  hidden  class="selection_mode_input " value="INCLUDE">
                                      </div>
                                    </div>
                                </td>
                                <td> <!--Country-->
                                  <div  onclick="import_country_list(this)" class="comboTreeWrapper ">
                                    <div  class="comboTreeInputWrapper country" >
                                        <div  style="background-color:transparent; border-style: None "  class="justAnInputBox comboTreeInputBox " 
                                        >{% if rule.country_incl_excl == "EXCLUDE" %}{% if rule.country_list != "---" %}All except : {{ rule.country_list}}{% else %}All{% endif %}{% else %}{{ rule.country_list }}{% endif %}</div >
                                      <input  class="comboTreeHiddenBox "  
                                        {% if rule.country_list == "---" %}
                                          value=''
                                        {% else %} 
                                          value='{{rule.country_list}}' 
                                        {% endif %} type="text" hidden  > 
                                        <input  hidden  class="selection_mode_input " value="{{rule.country_incl_excl}}">
                                      </div>
                                  </div>
                                </td>
                                <td style="padding: 4.8px 0px"><!--Date From-->
                                  <input class="period_from" style="background-color:transparent; border-style: None;width:125px " min="1900-01-01" max="2200-12-31" type="date" value={{rule.period_from|date:"Y-m-d"}}>
                                </td>
                                <td style="padding: 4.8px 0px"><!--Date To-->
                                  <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31"type="date" value={{rule.period_to|date:"Y-m-d"}}>
                                </td>
                                <td style="padding: 4.8px 0px"><!--Qty or Rate-->
                                  <select style="width: 53px" class="fname field_type"  onchange="tranche_field_ROYALTY(this)">
                                        <option value="RATE" {% if rule.field_type == 'RATE' %}selected{% endif  %}>RATE</option>
                                        <option value="QTY" {% if rule.field_type == 'QTY' %}selected{% endif  %}>QTY</option>
                                  </select>
                                </td>
                                <td style="padding: 4.8px 0px"><!--YES/NO Tranche-->
                                  <select style="width: 53px" class="fname tranche_type"  onchange="tranche_field_ROYALTY(this)">
                                        <option value="NO" {% if rule.tranche_type == 'NO' %}selected{% endif  %}>NO</option>
                                        <option value="YES" {% if rule.tranche_type == 'YES' %}selected{% endif  %}>YES</option>
                                  </select>
                                </td>
                                <td > <!--royalty rules-->
                                  <!-- Rate percentage-->
                                  <div {% if rule.tranche_type == 'YES' or rule.field_type == 'QTY' %}hidden {% endif  %}>
                                    <input class="rate_value" style="width:100%;background-color: transparent;border-style: None;"  placeholder="%" onchange="convert_percentage(this)" type="number" value={{rule.rate_value|floatformat:2}}>
                                  </div>
                                  <!--table for tranches-->
                                  <div {% if rule.tranche_type == 'NO' or rule.field_type == 'QTY' %}hidden {% endif  %}>
                                    <table class="table table-striped " style="background-color:white;max-width: 500px">
                                      <thead>
                                        <tr>
                                          <th>from</th>
                                          <th >to</th>
                                          <th>rate</th>
                                          <th style="max-width:70px">
                                            <select class ="tranche_currency" style=" background-color:transparent; border:None ;width:60px">
                                              {% for curr in currency_list %}
                                                {% if rule.tranche_currency == curr %}
                                                  <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                                {% else %}
                                                  <option value={{curr.currency}}>{{curr.currency}}</option>          
                                                {% endif %}
                                              {% endfor %}
                                            </select>
                                          </th>
                                        </tr>
                                      </thead>
                                      <tbody class="tranche_tbody" >
                                        {% for tranche in tranche_list_WRITER %}
                                          {% if tranche.rule == rule %}
                                          <tr>
                                            <td class="from_tranche">{{tranche.from_amount|floatformat:"-3g"}}</td>
                                            <td {% if tranche.to_amount == 0 %}onchange="add_row_tranche_rate(this)"{% endif %}>
                                              <input value='{% if tranche.to_amount == 0 %}{% else %}{{tranche.to_amount|floatformat:"-3g"}}{% endif %}' onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="∞"  type="text">
                                            </td>
                                            <td>
                                              <input class="rate_tranche" value={{tranche.percentage}} style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                                            </td>
                                            <td>
                                              <button  {% if tranche.to_amount == 0 %}hidden{% endif %} class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px" ><span class="bi bi-trash"></span></button></td>
                                          </tr>
                                          {% endif %}
                                        {% endfor %}
                  
                                        {% if rule.tranche_type == 'NO' or rule.field_type == 'QTY' %}
                                        <tr>
                                          <td class="from_tranche">0</td>
                                          <td onchange="add_row_tranche_rate(this)">
                                            <input onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="∞"   type="text">
                                          </td>
                                          <td>
                                            <input class="rate_tranche" style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                                          </td>
                                          <td >
                                            <button   hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px" ><span class="bi bi-trash"></span></button>
                                          </td>
                                        </tr>
                                        {% endif %}
                                      <tbody>
                                    </table>
                                  </div>
                                  <!-- Qty amount-->
                                  <div {% if rule.tranche_type == 'YES' or rule.field_type == 'RATE' %} hidden {% endif  %} style="display:flex">
                                    <input class="number-separator qty_value" style="max-width:80px;background-color: transparent;border-style: None;" placeholder="price per unit"  type="text" value={{rule.qty_value|floatformat:"-3g"}}>
                                    <!--<input  style="width:60px ;background-color: transparent;border-style: None" onclick="import_qty_value_currency(this)" value={{rule.qty_value_currency}}  >-->
                                    <select class ="qty_value_currency" style=" background-color:transparent; border:None ;width:60px">
                                      {% for curr in currency_list %}
                                        {% if rule.qty_value_currency == curr %}
                                          <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                        {% else %}
                                          <option value={{curr.currency}}>{{curr.currency}}</option>          
                                        {% endif %}
                                      {% endfor %}
                                    </select>
                                  </div>
                                <!-- Tranche for qty : not available-->
                                  <div {% if rule.tranche_type == 'NO' or rule.field_type == 'RATE' %}hidden {% endif  %}>
                                    <span>functionality not activated</span>
                                  </div>
                                </td>
                                <td ><!-- Delete Button-->
                                  <button  class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                                </td>
                              </tr>         
                            {% endif %}
                          {% endfor %}
                          <tr> <!--empty New row-->
                            <td onchange="add_new_row(this,'{{rule_type}}')"> <!--Formulation-->
                              <div  onclick="import_form_list(this)" class="comboTreeWrapper" >
                                  <div  class="comboTreeInputWrapper formulation" >
                                    <div style="width: 100%;color:grey "   class="justAnInputBox comboTreeInputBox "   >Select</div>
                                    <input  class="comboTreeHiddenBox " type="text" hidden > 
                                    <input  hidden  class="selection_mode_input " value="INCLUDE">
                                  </div>
                                </div>
                            </td>
                            <td> <!--Country-->
                              <div onclick="import_country_list(this)" class="comboTreeWrapper">
                                <div  class="comboTreeInputWrapper country" >
                                  <div style="width: 100%;color:grey "   class="justAnInputBox comboTreeInputBox ">Select</div>
                                  <input class="comboTreeHiddenBox "  type="text" hidden  > 
                                  <input  hidden  class="selection_mode_input " value="INCLUDE">
                                </div>
                              </div>
                            </td>
                            <td style="padding: 4.8px 0px"><!--Date From-->
                              <input class="period_from" style="background-color:transparent; border-style: None;width:125px;  "  min="1900-01-01" max="2200-12-31" type="date" value="1900-01-01">
                            </td>
                            <td style="padding: 4.8px 0px"><!--Date To-->
                              <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31" type="date" value="2200-12-31">
                            </td>
                            <td style="padding: 4.8px 0px"><!--Qty or Rate-->
                              <select style="width: 53px" class="fname field_type"  onchange="tranche_field_ROYALTY(this)">
                                    <option value="RATE" selected="selected">RATE</option>
                                    <option value="QTY" >QTY</option>
                              </select>
                            </td>
                            <td style="padding: 4.8px 0px"> <!--YES/NO Tranche-->
                              <select style="width: 53px" class="fname tranche_type"  onchange="tranche_field_ROYALTY(this)">
                                    <option value="NO" selected="selected">NO</option>
                                    <option value="YES" >YES</option>
                              </select>
                            </td>
                            <td ><!-- royalty rules-->
                              <div><!-- Rate percentage-->
                                <input class="rate_value" style="width:100%;background-color: transparent;border-style: None;"  placeholder="%" onchange="convert_percentage(this)" type="number">
                              </div>
              
                              <div hidden><!--table for tranches-->
                                <table class="table table-striped " style="background-color:white;max-width: 500px">
                                  <thead>
                                    <tr>
                                      <th>from</th>
                                      <th>to</th>
                                      <th>rate</th>
                                      <th   style="max-width: 70px">
                                        <select class ="tranche_currency" style=" background-color:transparent; border:None ;width:60px">
                                          {% for curr in currency_list %}
                                            {% if contract.contract_currency == curr %}
                                              <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                            {% else %}
                                              <option value={{curr.currency}}>{{curr.currency}}</option>          
                                            {% endif %}
                                          {% endfor %}
                                        </select>
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody class="tranche_tbody">
                                    <tr>
                                      <td class="from_tranche">0</td>
                                      <td onchange="add_row_tranche_rate(this)">
                                        <input onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="sales"   type="text">
                                      </td>
                                      <td>
                                        <input class="rate_tranche" style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                                      </td>
                                      <td >
                                        <button   hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                                      </td>
                                    </tr>
                                  <tbody>
                                </table>
                              </div>
              
                              <div hidden  style="display:flex"><!-- Qty amount-->
                                <input class="number-separator qty_value" style="max-width:80px;background-color: transparent;border-style: None;" placeholder="price per unit"  type="text">
                                <select  style=" background-color:transparent; border:None ;width:60px" class="qty_value_currency">
                                  {% for curr in currency_list %}
                                    {% if contract.contract_currency == curr %}
                                      <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                    {% else %}
                                      <option value={{curr.currency}}>{{curr.currency}}</option>          
                                    {% endif %}
                                  {% endfor %}
                                </select>
                              </div>
                            
                              <div hidden><!-- Tranche for qty : not available-->
                                <span>functionality not activated</span>
                              </div>
                            </td>
                            <td ><!-- Delete Button-->
                              <button   hidden class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                            </td>
                          </tr>
                        </tbody>
              
                      </table>
                    </div> 
                    <!-- new Rule: when the user change the value of the last row (formulation cell), we automatically enter a new row-->
                    <table hidden>
                      <tbody id="hidden_row_{{rule_type}}"> 
                        <tr>
                          <td onchange="add_new_row(this,'{{rule_type}}')" ><!--Formulation  -->
                            <div  class="comboTreeWrapper">
                                <div  class="comboTreeInputWrapper formulation" >
                                  <div style="width:100%;color:grey "  class="justAnInputBox comboTreeInputBox "  >Select</div>
                                  <input  class="comboTreeHiddenBox "  type="text" hidden  > 
                                  <input  hidden  class="selection_mode_input " value="INCLUDE">
                                </div>
                                <div  class="comboTreeDropDownContainer"  style="display: none;">
                                  <input  type="text" style="width:100%" class="multiplesFilter" placeholder="Type to filter" >
                                    <ul  >
                                      <li class="selection_mode" >
                                        <input hidden type="checkbox" class="select_all_box"   style="margin-right:5px;"  value="Select all exept:">Select all exept
                                      </li>
                                      {% for formulation in formulation_list %}
                                        <li   style="display: block;">
                                          <input type="checkbox" style="margin-right:5px;"  item_code="{{formulation.formula_code}}" item_display="{{formulation.formula_name}}" >
                                          <span>{{formulation.formula_code}} : {{formulation.formula_name}}</span>
                                        </li>
                                      {% endfor %}
                                    </ul>
                                </div>
                              </div>
                          </td>
                          <td><!--Country-->
                            <div  class="comboTreeWrapper ">
                              <div  class="comboTreeInputWrapper country" >
                                <div style="width:100%;color:grey "  class="justAnInputBox comboTreeInputBox "   >Select</div>
                                <input  class="comboTreeHiddenBox " type="text" hidden > 
                                <input  hidden  class="selection_mode_input " value="INCLUDE">
                              </div>
                              <div  class="comboTreeDropDownContainer" style="display: none;">
                                <input  type="text" style="width:100%" class="multiplesFilter" placeholder="Type to filter" >
                                  <ul  >
                                    <li class="selection_mode" >
                                      <input type="checkbox" class="select_all_box"   style="margin-right:5px;"  value="Select all exept:">Select all exept
                                    </li>
                                    {% for region in region_list %}
                                      <li>
                                        <span class="bi bi-chevron-down comboTreeParentPlus"  ></span>
                                        <span class="group" >{{region.region}}</span>
                                        <ul style="display: block;" >
                                          {% for country in country_list %}
                                            {% if country.country_region == region %}
                                            <li   style="display: block;">
                                              <input type="checkbox" style="margin-right:5px;" item_code="{{country.country_id}}" item_display="{{country.country}}" >
                                              <span>{{country.country_id}} : {{country.country}}</span>
                                            </li>
                                            {% endif  %}
                                          {% endfor %}
                                        </ul>
                                      </li>
                                    {% endfor %}
                                  </ul>
                              </div>
                            </div>
                          </td>
                          <td style="padding: 4.8px 0px"><!--Date From-->
                            <input class="date_from" style="background-color:transparent; border-style: None;width:125px" min="1900-01-01" max="2200-12-31" type="date" value="1900-01-01">
                          </td>
                          <td style="padding: 4.8px 0px"><!--Date To-->
                            <input class="date_to"  style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31" type="date" value="2100-01-01">
                          </td>
                          <td style="padding: 4.8px 0px"><!--Qty or Rate-->
                            <select style="width: 53px" class="fname field_type"  onchange="tranche_field_ROYALTY(this)">
                                  <option value="RATE" selected="selected">RATE</option>
                                  <option value="QTY" >QTY</option>
                            </select>
                          </td>
                          <td style="padding: 4.8px 0px"><!--YES/NO Tranche-->
                            <select style="width: 53px" class="fname tranche_type"  onchange="tranche_field_ROYALTY(this)">
                                  <option value="NO" selected="selected">NO</option>
                                  <option value="YES" >YES</option>
                            </select>
                          </td>
                          <td> <!--royalty rules-->
                            <div>
                              <input class="rate_value" style="width:100%;background-color: transparent;border-style: None;"  placeholder="%" onchange="convert_percentage(this)" type="number">
                            </div>
                            <div hidden><!--Tranche or Rate-->
                              <table class="table table-striped " style="background-color:white;max-width: 500px">
                                <thead>
                                  <tr>
                                    <th >from</th>
                                    <th>to </th>
                                    <th>rate</th>
                                    <th style="max-width: 70px">
                                      <select class ="tranche_currency" style=" background-color:transparent; border:None ;width:60px">
                                        {% for curr in currency_list %}
                                          {% if contract.contract_currency == curr %}
                                            <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                          {% else %}
                                            <option value={{curr.currency}}>{{curr.currency}}</option>          
                                          {% endif %}
                                        {% endfor %}
                                      </select>
                                    </th>
                                  </tr>
                                </thead>
                                <tbody class="tranche_tbody">
                                  <tr>
                                    <td class="from_tranche">0</td>
                                    <td onchange="add_row_tranche_rate(this)">
                                      <input onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="sales"   type="text">
                                    </td>
                                    <td>
                                      <input class="rate_tranche" style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                                    </td>
                                    <td >
                                      <button   hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button></td>
                                    </tr>
                                <tbody>
                              </table>
                            </div>
                            <div  hidden style="display:flex"><!--Qty-->
                              <input class="number-separator qty_value" style="width:80px;background-color: transparent;border-style: None;" placeholder="price per unit"  type="text">
                              <select style=" background-color:transparent; border:None ;width:60px" class="qty_value_currency">
                                {% for curr in currency_list %}
                                  {% if contract.contract_currency == curr %}
                                    <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                  {% else %}
                                    <option value={{curr.currency}}>{{curr.currency}}</option>          
                                  {% endif %}
                                {% endfor %}
                              </select>
              
                            </div>
                            <div  hidden><!--tranche Qty-->
                              <span>functionality not activated</span> 
                            </div>
                          </td>
                          <td ><!-- Delete Button-->
                            <button hidden   class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                          </td>
                        <tr>
                      </tbody>
                    </table>
                  {% endwith %}
                <!----------------------------MARGIN--------------------------------------> 

                  {% with rule_type="MARGIN" %}
                    {% if contract_WRITER.contract_type.name == "MARGIN_ADJ" %}
                      <span >{{rule_type}}</span>
                    
                      <div class="content rule"> 
                        <table style="width:100%" class="table table-striped table-sm " id="writer_{{rule_type}}" >
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width: 125px;padding: 4.8px 0px">Period from</th>
                              <th style="width: 125px;padding: 4.8px 0px">Period to</th>
                              <th style="width: 106px;padding: 4.8px 0px">Tranche</th>
                              <th style="width: 70px" >MARGIN</th>
                              <th ></th>
                            </tr>
                          </thead>
                          
                          <tbody class="tbody_writer">
                            {% for rule in rule_list_WRITER %}
                              {% if rule.rule_type == rule_type %}
                                <tr> 
                                  <td > <!--Formulation  -->
                                    <div onclick="import_form_list(this)" class="comboTreeWrapper" >
                                        <div  class="comboTreeInputWrapper formulation" >
                                          <div  style="width: 100%"  class="justAnInputBox comboTreeInputBox ">
                                            {% for form in rule.formulation.all %}{% if forloop.counter0 != 0 %}, {% endif %}{{form.formula_name}}{% endfor %}
                                          </div>
                                          <input class="comboTreeHiddenBox "   value='{{ rule.formulation.all|join:", " }}'  type="text" hidden  > 
                                          <input  hidden  class="selection_mode_input " value="INCLUDE">
                                        </div>
                                      </div>
                                  </td>
                                  <td> <!--Country-->
                                    <div  onclick="import_country_list(this)" class="comboTreeWrapper ">
                                      <div  class="comboTreeInputWrapper country" >
                                          <div  style="background-color:transparent; border-style: None "  class="justAnInputBox comboTreeInputBox "
                                          >{% if rule.country_incl_excl == "EXCLUDE" %}{% if rule.country_list != "---" %}All except : {{ rule.country_list}}{% else %}All{% endif %}{% else %}{{ rule.country_list }}{% endif %}</div >
                                        <input  class="comboTreeHiddenBox "   
                                          {% if rule.country_list == "---" %}
                                            value=''
                                          {% else %} 
                                            value='{{rule.country_list}}' 
                                          {% endif %} type="text" hidden  > 
                                          <input  hidden  class="selection_mode_input " value="{{rule.country_incl_excl}}">
                                        </div>
                                    </div>
                                  </td>
                                  <td style="padding: 4.8px 0px"><!--Date From-->
                                    <input class="period_from" style="background-color:transparent; border-style: None;width:125px " min="1900-01-01" max="2200-12-31" type="date" value={{rule.period_from|date:"Y-m-d"}}>
                                  </td>
                                  <td style="padding: 4.8px 0px"><!--Date To-->
                                    <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31"type="date" value={{rule.period_to|date:"Y-m-d"}}>
                                  </td>
                                  <td hidden style="padding: 4.8px 0px"><!--Qty or Rate-->
                                    <select style="width: 53px" class="fname field_type" >
                                          <option value="RATE" selected >RATE</option>
                                          <option value="QTY">QTY</option>
                                    </select>
                                  </td>
                                  <td style="padding: 4.8px 0px"><!--YES/NO Tranche-->
                                    <select style="width: 53px" class="fname tranche_type"  onchange="tranche_field_ROYALTY(this)">
                                          <option value="NO" {% if rule.tranche_type == 'NO' %}selected{% endif  %}>NO</option>
                                          <option value="YES" {% if rule.tranche_type == 'YES' %}selected{% endif  %}>YES</option>
                                    </select>
                                  </td>
                                  <td > <!--royalty rules-->
                                    <!-- Rate percentage-->
                                    <div {% if rule.tranche_type == 'YES'  %}hidden {% endif  %}>
                                      <input class="rate_value" style="width:100%;background-color: transparent;border-style: None;"  placeholder="%" onchange="convert_percentage(this)" type="number" value={{rule.rate_value|floatformat:2}}>
                                    </div>
                                    <!--table for tranches-->
                                    <div {% if rule.tranche_type == 'NO'  %}hidden {% endif  %}>
                                      <table class="table table-striped " style="background-color:white;max-width: 500px">
                                        <thead>
                                          <tr>
                                            <th>from</th>
                                            <th >to</th>
                                            <th>rate</th>
                                            <th style="max-width:70px">
                                              <select class ="tranche_currency" style=" background-color:transparent; border:None ;width:60px">
                                                {% for curr in currency_list %}
                                                  {% if rule.tranche_currency == curr %}
                                                    <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                                  {% else %}
                                                    <option value={{curr.currency}}>{{curr.currency}}</option>          
                                                  {% endif %}
                                                {% endfor %}
                                              </select>
                                            </th>
                                          </tr>
                                        </thead>
                                        <tbody class="tranche_tbody" >
                                          {% for tranche in tranche_list_WRITER %}
                                            {% if tranche.rule == rule %}
                                            <tr>
                                              <td class="from_tranche">{{tranche.from_amount|floatformat:"-3g"}}</td>
                                              <td {% if tranche.to_amount == 0 %}onchange="add_row_tranche_rate(this)"{% endif %}>
                                                <input value='{% if tranche.to_amount == 0 %}{% else %}{{tranche.to_amount|floatformat:"-3g"}}{% endif %}' onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="∞"  type="text">
                                              </td>
                                              <td>
                                                <input class="rate_tranche" value={{tranche.percentage}} style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                                              </td>
                                              <td>
                                                <button  {% if tranche.to_amount == 0 %}hidden{% endif %} class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px" ><span class="bi bi-trash"></span></button></td>
                                            </tr>
                                            {% endif %}
                                          {% endfor %}
                    
                                          {% if rule.tranche_type == 'NO' or rule.field_type == 'QTY' %}
                                          <tr>
                                            <td class="from_tranche">0</td>
                                            <td onchange="add_row_tranche_rate(this)">
                                              <input onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="∞"   type="text">
                                            </td>
                                            <td>
                                              <input class="rate_tranche" style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                                            </td>
                                            <td >
                                              <button   hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px" ><span class="bi bi-trash"></span></button>
                                            </td>
                                          </tr>
                                          {% endif %}
                                        <tbody>
                                      </table>
                                    </div>

                                    <div></div>
                                    <div></div>

                                  </td>
                                  <td ><!-- Delete Button-->
                                    <button  class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                                  </td>
                                </tr>         
                              {% endif %}
                            {% endfor %}
                            <tr> <!--empty New row-->
                              <td onchange="add_new_row(this,'{{rule_type}}')"> <!--Formulation-->
                                <div  onclick="import_form_list(this)" class="comboTreeWrapper" >
                                    <div  class="comboTreeInputWrapper formulation" >
                                      <div style="width: 100%;color:grey "   class="justAnInputBox comboTreeInputBox " >Select</div>
                                      <input class="comboTreeHiddenBox "   type="text" hidden  > 
                                      <input  hidden  class="selection_mode_input " value="INCLUDE">
                                    </div>
                                  </div>
                              </td>
                              <td> <!--Country-->
                                <div onclick="import_country_list(this)" class="comboTreeWrapper ">
                                  <div  class="comboTreeInputWrapper country" >
                                    <div style="width: 100%;color:grey "   class="justAnInputBox comboTreeInputBox " d>Select</div>
                                    <input   class="comboTreeHiddenBox " type="text" hidden  > 
                                    <input  hidden  class="selection_mode_input " value="INCLUDE">
                                  </div>
                                </div>
                              </td>
                              <td style="padding: 4.8px 0px"><!--Date From-->
                                <input class="period_from" style="background-color:transparent; border-style: None;width:125px;  "  min="1900-01-01" max="2200-12-31" type="date" value="1900-01-01">
                              </td>
                              <td style="padding: 4.8px 0px"><!--Date To-->
                                <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31" type="date" value="2200-12-31">
                              </td>
                              <td hidden style="padding: 4.8px 0px"><!--Qty or Rate-->
                                <select style="width: 53px" class="fname field_type" >
                                      <option value="RATE" selected >RATE</option>
                                      <option value="QTY">QTY</option>
                                </select>
                              </td>
                              <td style="padding: 4.8px 0px"> <!--YES/NO Tranche-->
                                <select style="width: 53px" class="fname tranche_type"  onchange="tranche_field_ROYALTY(this)">
                                      <option value="NO" selected="selected">NO</option>
                                      <option value="YES" >YES</option>
                                </select>
                              </td>
                              <td ><!-- royalty rules-->
                                <div><!-- Rate percentage-->
                                  <input class="rate_value" style="width:100%;background-color: transparent;border-style: None;"  placeholder="%" onchange="convert_percentage(this)" type="number">
                                </div>
                
                                <div hidden><!--table for tranches-->
                                  <table class="table table-striped " style="background-color:white;max-width: 500px">
                                    <thead>
                                      <tr>
                                        <th>from</th>
                                        <th>to</th>
                                        <th>rate</th>
                                        <th   style="max-width: 70px">
                                          <select class ="tranche_currency" style=" background-color:transparent; border:None ;width:60px">
                                            {% for curr in currency_list %}
                                              {% if contract.contract_currency == curr %}
                                                <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                              {% else %}
                                                <option value={{curr.currency}}>{{curr.currency}}</option>          
                                              {% endif %}
                                            {% endfor %}
                                          </select>
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody  class="tranche_tbody">
                                      <tr>
                                        <td class="from_tranche">0</td>
                                        <td onchange="add_row_tranche_rate(this)">
                                          <input onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="sales"   type="text">
                                        </td>
                                        <td>
                                          <input class="rate_tranche" style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                                        </td>
                                        <td >
                                          <button   hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                                        </td>
                                      </tr>
                                    <tbody>
                                  </table>
                                </div>

                                <div></div>
                                <div></div>
                              </td>
                              <td ><!-- Delete Button-->
                                <button   hidden class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                              </td>
                            </tr>
                          </tbody>
                
                        </table>
                      </div> 
                      <!-- new Rule: when the user change the value of the last row (formulation cell), we automatically enter a new row-->
                      <table hidden>
                        <tbody id="hidden_row_{{rule_type}}"> 
                          <tr>
                            <td onchange="add_new_row(this,'{{rule_type}}')" ><!--Formulation  -->
                              <div  class="comboTreeWrapper">
                                  <div  class="comboTreeInputWrapper formulation" >
                                    <div style="width:100%;color:grey "  class="justAnInputBox comboTreeInputBox "  >Select</div>
                                    <input   class="comboTreeHiddenBox " type="text" hidden  > 
                                    <input  hidden  class="selection_mode_input " value="INCLUDE">
                                  </div>
                                  <div  class="comboTreeDropDownContainer"  style="display: none;">
                                    <input  type="text" class="multiplesFilter" style="width:100%" placeholder="Type to filter" >
                                      <ul  >
                                        <li class="selection_mode" >
                                          <input hidden type="checkbox" class="select_all_box"   style="margin-right:5px;"  value="Select all exept:">Select all exept
                                        </li>
                                        {% for formulation in formulation_list %}
                                          <li   style="display: block;">
                                            <input type="checkbox" style="margin-right:5px;"  item_code="{{formulation.formula_code}}" item_display="{{formulation.formula_name}}" >
                                            <span>{{formulation.formula_code}} : {{formulation.formula_name}}</span>
                                          </li>
                                        {% endfor %}
                                      </ul>
                                  </div>
                                </div>
                            </td>
                            <td><!--Country-->
                              <div  class="comboTreeWrapper">
                                <div  class="comboTreeInputWrapper country" >
                                  <div style="width:100%;color:grey "  class="justAnInputBox comboTreeInputBox "  >Select</div>
                                  <input   class="comboTreeHiddenBox " type="text" hidden  > 
                                  <input  hidden  class="selection_mode_input" value="INCLUDE">
                                </div>
                                <div  class="comboTreeDropDownContainer"  style="display: none;">
                                  <input  type="text" class="multiplesFilter" style="width:100%" placeholder="Type to filter" >
                                    <ul  >
                                      <li class="selection_mode" >
                                        <input type="checkbox" class="select_all_box"  style="margin-right:5px;"  value="Select all exept:">Select all exept
                                      </li>
                                      {% for region in region_list %}
                                        <li>
                                          <span class="bi bi-chevron-down comboTreeParentPlus"  ></span>
                                          <span class="group" >{{region.region}}</span>
                                          <ul style="display: block;" >
                                            {% for country in country_list %}
                                              {% if country.country_region == region %}
                                              <li   style="display: block;">
                                                <input type="checkbox" style="margin-right:5px;" item_code="{{country.country_id}}" item_display="{{country.country}}"  >
                                                <span>{{country.country_id}} : {{country.country}}</span>
                                              </li>
                                              {% endif  %}
                                            {% endfor %}
                                          </ul>
                                        </li>
                                      {% endfor %}
                                    </ul>
                                </div>
                              </div>
                            </td>
                            <td style="padding: 4.8px 0px"><!--Date From-->
                              <input class="period_from" style="background-color:transparent; border-style: None;width:125px" min="1900-01-01" max="2200-12-31" type="date" value="1900-01-01">
                            </td>
                            <td style="padding: 4.8px 0px"><!--Date To-->
                              <input class="period_to" style="background-color:transparent; border-style: None;width:125px "  min="1900-01-01" max="2200-12-31" type="date" value="2100-01-01">
                            </td>
                            <td hidden style="padding: 4.8px 0px"><!--Qty or Rate-->
                              <select style="width: 53px" class="fname field_type" >
                                    <option value="RATE" selected >RATE</option>
                                    <option value="QTY">QTY</option>
                              </select>
                            </td>
                            <td style="padding: 4.8px 0px"><!--YES/NO Tranche-->
                              <select style="width: 53px" class="fname tranche_type"  onchange="tranche_field_ROYALTY(this)">
                                    <option value="NO" selected="selected">NO</option>
                                    <option value="YES" >YES</option>
                              </select>
                            </td>
                            <td> <!--royalty rules-->
                              <div>
                                <input class="rate_value" style="width:100%;background-color: transparent;border-style: None;"  placeholder="%" onchange="convert_percentage(this)" type="number">
                              </div>
                              <div hidden><!--Tranche or Rate-->
                                <table class="table table-striped " style="background-color:white;max-width: 500px">
                                  <thead>
                                    <tr>
                                      <th >from</th>
                                      <th>to </th>
                                      <th>rate</th>
                                      <th style="max-width: 70px">
                                        <select class ="tranche_currency" style=" background-color:transparent; border:None ;width:60px">
                                          {% for curr in currency_list %}
                                            {% if contract.contract_currency == curr %}
                                              <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                                            {% else %}
                                              <option value={{curr.currency}}>{{curr.currency}}</option>          
                                            {% endif %}
                                          {% endfor %}
                                        </select>
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody class="tranche_tbody">
                                    <tr>
                                      <td class="from_tranche">0</td>
                                      <td onchange="add_row_tranche_rate(this)">
                                        <input onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="sales"   type="text">
                                      </td>
                                      <td>
                                        <input class="rate_tranche"  style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                                      </td>
                                      <td >
                                        <button   hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button></td>
                                      </tr>
                                  <tbody>
                                </table>
                              </div>
                              <div></div>
                              <div></div>
                            </td>
                            <td ><!-- Delete Button-->
                              <button hidden   class="btn btn-sm btn-outline-danger delete_button" title="delete" onclick="delete_rule(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button>
                            </td>
                          <tr>
                        </tbody>
                      </table>
                    {% endif %}
                  {% endwith %}
              </div>
              <!------------------------ctry and formulation------------------------------> 
                <!--when user click on country or formulation table, we import the element ---->
                  
                  <table hidden><!--new tranche: --> 
                    <tbody id="hidden_tranche_rate_row">
                      <tr>
                        <td class="from_tranche">0</td>
                        <td onchange="add_row_tranche_rate(this)" >
                          <input onchange="new_to_value_tranche_rate(this)" class="number-separator to_tranche" style="width:100px;background-color: transparent;border-style: None;" placeholder="∞"  type="text">
                        </td>
                        <td>
                          <input class="rate_tranche" style="width:60px;background-color: transparent;border-style: None;" placeholder="%" onchange="convert_percentage(this)" type="number">
                        </td>
                        <td>
                          <button  hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_tranche_rate(this)" style="border:0px;float:right" ><span class="bi bi-trash"></span></button></td>
                        </tr>
                    <tbody>
                  </table>
                  
                  <div id="import_form_list"><!--import formulation list-->
                    <div  class="comboTreeDropDownContainer"  style="display: none;">
                      <input  type="text" class="multiplesFilter" style="width:100%" placeholder="Type to filter" >
                        <ul  >
                          <li hidden class="selection_mode" >
                            <input  type="checkbox" class="select_all_box"  style="margin-right:5px;"  value="Select all exept:">Select all exept
                          </li>
                          {% for formulation in formulation_list %}
                            <li   style="display: block;">
                              <input type="checkbox" style="margin-right:5px;"  item_code="{{formulation.formula_code}}" item_display="{{formulation.formula_name}}">
                              <span>{{formulation.formula_code}} : {{formulation.formula_name}}</span>
                            </li>
                          {% endfor %}
                        </ul>
                    </div>
                  </div>
                
                  <div id="import_country_list"><!--import country list--> 
                    <div  class="comboTreeDropDownContainer" style="display: none;">
                      <input  type="text" class="multiplesFilter" style="width:100%" placeholder="Type to filter" >
                      <ul  >
                        <li class="selection_mode" >
                          <input {% if rule.country_incl_excl == "EXCLUDE" %}checked{% endif %} type="checkbox" class="select_all_box"  style="margin-right:5px;"  value="Select all exept:">Select all exept
                        </li>
                        {% for region in region_list %}
                          <li>
                            <span class="bi bi-chevron-down comboTreeParentPlus"  ></span>
                            <span class="group" >{{region.region}}</span>
                            <ul style="display: block;" >
                              {% for country in country_list %}
                                {% if country.country_region == region %}
                                <li   style="display: block;">
                                    <input type="checkbox" style="margin-right:5px;"  item_code="{{country.country_id}}" item_display="{{country.country}}">
                                    <span>{{country.country_id}} : {{country.country}}</span>                            
                                </li>
                                {% endif  %}
                              {% endfor %}
                            </ul>
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                
                  <div id="import_currency_list" style="display: none"><!--import currency list--> 
                    <select style=" background-color:transparent; border:None ;width:60px">
                      {% for curr in currency_list %}
                          <option value={{curr.currency}}>{{curr.currency}}</option>          
                      {% endfor %}
                    </select>
                  </div>

            <!----------------------------------Milestone payment-------------------------->
              <div class="chevron">
                <span style="display: none;" class="bi bi-chevron-right " id="unhide_writer_milestone" onclick='unhide_table("writer_milestone")'></span>
                <span  class="bi bi-chevron-down" id="hide_writer_milestone" onclick='hide_table("writer_milestone")'></span>
                <h5 >Milestones</h5>
              </div>
              <div class="content milestone" id="writer_milestone" style="display: block;">
                <table   class="table table-striped table-sm  " style="max-width: 1000px ">
                  <thead>
                    <tr >
                      <th>Name</th>
                      <th>Amount</th>
                      <th>Currency</th>
                      <th>Booked</th>
                      <th>Market</th>
                      <th>Booking date</th>
                      <th>Payment date</th>
                      <th style=" height: 45px;"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for milestone in milestone_list_WRITER %}
                      <tr >
                        <td style="min-width:100px"><!--Name-->
                          <input value="{{milestone.name}}" style="width:100%;background-color: transparent;border-style: None;" placeholder="Name" type="text">
                        </td>
                        <td style="min-width:100px"><!--Amount-->
                          <input value={{milestone.amount|floatformat:"-3g"}} class="number-separator" style="width:100%;background-color: transparent;border-style: None;" placeholder="amount" type="text">
                        </td>
                        <td><!--Currency-->
                          <select style=" background-color:transparent; border:None ;width:60px">
                            {% for curr in currency_list %}
                              {% if milestone.currency == curr %}
                                <option value={{curr.currency}} selected="selected">{{curr.currency}}</option>
                              {% else %}
                                <option value={{curr.currency}}>{{curr.currency}}</option>          
                              {% endif %}
                            {% endfor %}
                          </select>
                        </td>
                        <td ><!--booked-->
                          <select style=" background-color:transparent; border:None ;width:60px" onchange="booked_milestone(this)">
                              {% if milestone.booked == "YES" %}
                                <option value="YES" selected="selected">YES</option>
                                <option value="NO">NO</option>
                              {% else %}
                                <option value="YES" >YES</option>
                                <option value="NO" selected="selected">NO</option>         
                              {% endif %}
                          </select>
                        </td>
                        <td  style="width:80px"><!--Market-->
                          <select {% if milestone.booked == "NO" %} hidden {% endif %} style=" background-color:transparent; border:None ;width:100%">
                            {% for market in country_list %}
                              {% if milestone.market == market %}
                                <option value={{market.country_id}} selected="selected">{{market.country_id}}</option>
                              {% else %}
                                <option value={{market.country_id}}>{{market.country_id}}</option>          
                              {% endif %}
                            {% endfor %}
                          </select>
                        </td>
                        <td style="width:140px"><!--Booking date-->
                          <input {% if milestone.booked == "NO" %} hidden {% endif %} style="background-color:transparent; border-style: None;width:130px "  type="date" value={{milestone.booking_date|date:"Y-m-d"}}>
                        </td>
                        <td style="width:140px"><!--Payment date-->
                          <input {% if milestone.booked == "NO" %} hidden {% endif %} style="background-color:transparent; border-style: None;width:130px "  type="date" value={{milestone.payment_date|date:"Y-m-d"}}>
                        </td>
                        <td ><!--Button-->
                          <button   class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_milestone(this,{{contract.id}})" style="border:0px" ><span class="bi bi-trash"></span></button>
                        </td>
                      </tr>
                    {% endfor %}
                    <tr id="new_milestone_tr">
                      <td style="min-width:100px" onchange="add_new_milestone(this)"><!--Name-->
                        <input style="width:100%;background-color: transparent;border-style: None;" placeholder="name" type="text">
                      <td style="min-width:100px"><!--amount-->
                        <input class="number-separator" style="width:100%;background-color: transparent;border-style: None;" placeholder="amount" type="text">
                      </td>
                      <td><!--Currency-->
                        <select style=" background-color:transparent; border:None ;width:60px">
                          <option value="" disabled selected></option>
                          {% for curr in currency_list %}
                              <option value={{curr.currency}}>{{curr.currency}}</option>          
                          {% endfor %}
                        </select>
                      </td>
                      <td><!--Booked-->
                        <select style=" background-color:transparent; border:None ;width:60px"  onchange="booked_milestone(this)">
                            <option value="" disabled selected></option>
                            <option value="YES" >YES</option>
                            <option value="NO">NO</option>        
                        </select>
                      </td>
                      <td style="width:80px"><!--Market-->
                        <select hidden style=" background-color:transparent; border:None ;width:100%">
                          <option value="" disabled selected></option>
                          {% for market in country_list %}
                            <option value={{market.country_id}}>{{market.country_id}}</option>          
                          {% endfor %}
                        </select>
                      </td>
                      <td style="width:140px"><!--Booking date-->
                        <input hidden style="background-color:transparent; border-style: None;width:130px"  type="date">
                      </td>
                      <td style="width:140px"><!--Payment date-->
                        <input hidden style="background-color:transparent; border-style: None;width:130px"  type="date" >
                      </td>
                      <td >
                        <button  hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_milestone(this,{{contract.id}})" style="border:0px" ><span class="bi bi-trash"></span></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!--table for new milesrtone--> 
                <div>
                  <table  hidden >
                    <tbody id="hidden_row_milestone">
                      <tr >
                        <td onchange="add_new_milestone(this)" style="min-width:100px"><!--Name-->
                          <input  style="width:100%;background-color: transparent;border-style: None;" placeholder="name" type="text">
                        <td style="min-width:100px"><!--amount-->
                          <input  class="number-separator" style="width:100%;background-color: transparent;border-style: None;" placeholder="amount" type="text">
                        </td>
                        <td><!--Currency-->
                          <select style=" background-color:transparent; border:None ;width:60px">
                            <option value="" disabled selected></option>
                            {% for curr in currency_list %}
                                <option value={{curr.currency}}>{{curr.currency}}</option>          
                            {% endfor %}
                          </select>
                        </td>
                        <td><!--Booked-->
                          <select style=" background-color:transparent; border:None ;width:60px"  onchange="booked_milestone(this)">
                              <option value="" disabled selected></option>
                              <option value="YES" >YES</option>
                              <option value="NO">NO</option>        
                          </select>
                        </td>
                        <td style="width:80px"><!--Market-->
                          <select hidden style=" background-color:transparent; border:None ;width:100%">
                            <option value="" disabled selected></option>
                            {% for market in country_list %}
                              <option value={{market.country_id}}>{{market.country_id}}</option>          
                            {% endfor %}
                          </select>
                        </td>
                        <td style="width:140px"> <!--Booking date-->
                          <input hidden style="background-color:transparent; border-style: None;width:130px"  type="date">
                        </td>
                        <td style="width:140px"><!--Payment date-->
                          <input hidden style="background-color:transparent; border-style: None;width:130px"  type="date" >
                        </td>
                        <td >
                          <button  hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_milestone(this,{{contract.id}})" style="border:0px" ><span class="bi bi-trash"></span></button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

            <!----------------------------Beneficiary table-------------------------------->

              <div class="chevron">
                <span class="bi bi-chevron-right" id="unhide_writer_beneficiary" onclick='unhide_table("writer_beneficiary")' style="display: none;"></span>
                <span  class="bi bi-chevron-down" id="hide_writer_beneficiary" onclick='hide_table("writer_beneficiary")'></span>
                <h5 >Beneficiaries</h5>
              </div>
              <div class="content beneficiary" id="writer_beneficiary" style="display: block;">
                <table   class="table table-striped table-sm  "  style="max-width: 500px">
                  <thead>
                    <tr >
                      <th > Name</th>
                      <th style="width: 80px">%</th>
                      <th style="width: 50px;">

                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for cp in contract_partner_list_WRITER %}
                    <tr >
                      <td ><!--Partner-->
                        <select style="width:100%;background-color: transparent;border-style: hidden;">
                          <option disabled selected></option>
                          {% for p in partner_list %}
                            {% if p == cp.partner %}
                              <option value={{p.id}} selected="selected">{{p.partner_name}}</option>
                            {% else %}
                              <option value={{p.id}} >{{p.partner_name}}</option>
                            {% endif %}
                          {% endfor %}
                        </select>
                      </td>
                      <td><!--percentage-->
                        <input style="width:100%;background-color: transparent;border-style: hidden;" onchange="convert_percentage(this)" type="number" value={{cp.percentage}}>
                      </td>
                      <td ><!--Button-->
                        <button   class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_beneficiary(this,{{contract.id}})" style="border:0px" ><span class="bi bi-trash"></span></button>
                      </td>
                    </tr>
                    {% endfor %}
                    <tr id="new_beneficiary_tr">
                      <td >
                        <select onchange="add_new_row_beneficiary()" style="width:100%;background-color: transparent;border-style: hidden;">
                          <option disabled selected>new</option>
                          {% for p in partner_list %}
                            <option value={{p.id}}>{{p.partner_name}}</option>
                          {% endfor %}
                        </select>
                      </td>
                      <td>
                        <input style="width:100%;background-color: transparent;border-style: hidden;" onchange="convert_percentage(this)" type="number">
                      </td>
                      <td >
                        <button  hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_beneficiary(this,{{contract.id}})" style="border:0px" ><span class="bi bi-trash"></span></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!--dd for new beneficiary--> 
                <div hidden>
                  <div id="hidden_select" >
                      <select onchange="add_new_row_beneficiary()" style="width:100%;background-color: transparent;border-style: hidden;">
                        <option disabled selected >new</option>
                          {% for p in partner_list %}
                            <option value={{p.id}}>{{p.partner_name}}</option>
                          {% endfor %}
                      </select>
                  </div>
                  <div id="hidden_percentage">
                    <input style="width:100%;background-color: transparent;border-style: hidden;" onchange="convert_percentage(this)" type="number"> 
                  </div>

                  <div id="hidden_button">
                    <button hidden class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_row_beneficiary(this)" style="border:0px"><span class="bi bi-trash" ></span></button> 
                  </div>
                </div>
            <!----------------------------------Mini_guar---------------------------------->
              <div class="chevron">
                <span  class="bi bi-chevron-right" id="unhide_writer_mini_guar" onclick='unhide_table("writer_mini_guar")' style="display: none;"></span>
                <span  class="bi bi-chevron-down" id="hide_writer_mini_guar" onclick='hide_table("writer_mini_guar")'></span>
                <h5 >Minimum Guarantee</h5>
              </div>

              <div class="content mini_guar" id="writer_mini_guar"  style="display: block" >
                <div style=" display:grid;grid-template-columns: 320px 50px auto;margin-bottom:10px; width: 578px;">
                  <span>A minimum amount has to be paid/rec every year:</span>
                  <select   id="mini_gar_status" onchange="hide_unhide_mini(this)">
                    {% if "YES" == contract_WRITER.mini_gar_status  %}
                      <option value="YES" selected="selected">YES</option>
                    {% else%}
                      <option value="YES" >YES</option>
                    {% endif %}
                    {% if "NO" == contract_WRITER.mini_gar_status  %}
                      <option value="NO" selected="selected">NO</option>
                    {% else%}
                      <option value="NO" >NO</option>
                    {% endif %}
                  </select>
                </div>  

                <table style="margin-left:10px;width: 500px" class="table table-striped table-sm"   id="mini_table" {% if 'NO' == contract_WRITER.mini_gar_status  %} hidden {% endif %} id="head_table" >
                  <thead>
                    <tr  >
                      <th ><span>Amount</span></th>
                      <th><span>Country to allocate</span></th>
                      <th ><span>From</span></th>
                      <th ><span>To</span></th>
                    </tr>
                  </thead>
                  <tbody >
                    <tr >
                      <td ><!--Amount-->
                        <input type="text" class="fname number-separator"  id="minimum_guar_amount"  value='{{contract_WRITER.minimum_guar_amount|default_if_none:""|floatformat:"-3g"}}' style="width: 100%;">
                      </td>
                      <td ><!--Country-->
                        <span hidden=true  id="span_minimum_guar_remaining_allocation_country">searched_value:{{contract_WRITER.minimum_guar_remaining_allocation_country.country_id}} </span>
                        <select   class="fname" id="minimum_guar_remaining_allocation_country"  style="width:100%">
                          <!--Contrary to other fields, division via is not a mandatory field, hence, if this field is empty, we should select the value ""-->
                          {% if contract_WRITER.minimum_guar_remaining_allocation_country is None  %}
                            <option value="" selected="selected"></option>
                            {% else%}
                            <option value="" ></option>
                          {% endif %}  
                          {% for region in region_list %}  
                            <optgroup label={{region.region}}>
                              {% for country in country_list %}
                                {% if region == country.country_region%}
                                  {% if country == contract_WRITER.minimum_guar_remaining_allocation_country  %}
                                    <option value="{{ country.country_id }}" selected="selected">{{ country.country_id }}   </option> 
                                  {% else %}
                                    <option value="{{ country.country_id }}"> {{ country.country_id }} </option>
                                  {% endif %}
                                {% endif %}
                              {% endfor %}
                            </optgroup>
                          {% endfor %}
                        </select>
                      </td>
                      <td><!--Date From-->
                        <input style="background-color:transparent; border-style: None;width: 100%"  type="number" id="mini_gar_from" value="{{ contract_WRITER.mini_gar_from }}"  >
                      </td>

                      <td><!--Date To-->
                        <input style="background-color:transparent; border-style: None;width: 100% "  type="number" id="mini_gar_to" value="{{ contract_WRITER.mini_gar_to }}" >
                      </td>
                      <td></td>
                    </tr>
                  </tbody>
                </table>
              </div>  
            <!----------------------------Contract saved in PDF---------------------------->
              <div class="chevron">
                <span   class="bi bi-chevron-right  " id="unhide_writer_attachement" onclick='unhide_table("writer_attachement")' style="display: none;"></span>
                <span  class="bi bi-chevron-down " id="hide_writer_attachement" onclick='hide_table("writer_attachement")'></span>
                <h5 >Supporting document(s)</h5>
              </div>
              <div class="content attachement" id="writer_attachement"  style="display: block" >
                <table  class="table table-striped table-sm "  style="width: 500px">
                  <thead>
                    <tr >
                      <th hidden></th>
                      <th hidden></th>
                      <th >
                        <input  type="file" name="loaded_file"  accept=".pdf"  style="width: 100%" onchange="new_attachement(this)">
                      </th>
                      <th  >
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for a in attachement_list_WRITER %}
                    <tr >
                      <td hidden><!--File ID-->
                        <span>{{a.id}}</span>
                      </td>
                      <td hidden><!--File -->
                      </td>
                      <td ><!--File Name-->
                        <a href='{{a.upload.url}}'><span class="fname"  >{{a.name}}</span></a>
                      </td>
                      <td ><!--Button-->
                        <button   class="btn btn-sm btn-outline-danger" title="delete" onclick="delete_file(this,{{a.id}})" style="border:0px" ><span class="bi bi-trash"></span></button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            <!----------------------------------Sales_breakdown_per_contract--------------->
              <div class="chevron">
                <span class="bi bi-chevron-right"   id="unhide_writer_sales_breakdown" onclick='unhide_table("writer_sales_breakdown")' style="display: none;"></span>
                <span class="bi bi-chevron-down " id="hide_writer_sales_breakdown" onclick='hide_table("writer_sales_breakdown")'></span>
                <h5 >Breakdown of sales in invoice reporting</h5>
              </div>
              <div class="content sales_breakdown" id="writer_sales_breakdown"  style="display: block" >
                <table  class="table table-striped table-sm " style="width: 500px">
                  <thead>
                    <tr >
                      <th hidden></th>
                      <th>In import file</th>
                      <th>In contract report</th>
                      <th style="width: 30px">

                      </th>
                    </tr>
                  </thead>
                  
                  <tbody>
                    {% for item in sbd_WRITER %}
                    <tr> 
                      <td hidden>{{item.id}}</td>
                      <td >{{item.sales_breakdown_definition}}</td>
                      <td colspan="2" >
                        <input style="width:100%;background-color: transparent;border-style: None;" placeholder="N/A" type="text" value=
                          {% for contract_item in sbd_contract_WRITER %}
                            {% if contract_item.sales_breakdown_item == item  %}
                            "{{contract_item.sales_breakdown_contract_definition}}"
                            {% endif %}
                          {% endfor%}
                        >
                      </td>
                    </tr>
                    {% endfor%}
                  </tbody>
                </table>
              </div>
          </div>
        </div>
      {% endif%}
    <!-------------------------------------------------------------------------------------> 
    <!---------------------------pending validation----------------------------------------> 
    <!-------------------------------------------------------------------------------------> 

      {% if contract.status in 'NEW,CHANGE,DELETE' and user.role in 'READER,WRITER,VALIDATOR'  %}
        <div id="pending_validation" class="contract_tab" {% if contract.status == 'CHANGE' %} style="display: none;"{% endif%}>
          <!---------------------------Basic info on contract -----------------------------------> 
          <div class="top_chevron_row" >
            <div class="top_chevron_bar">
              <div class="top_chevron">
                <span style="display: none;" class="bi bi-chevron-right chevron_unhide"  onclick='unhide_dashboard()'></span>
                <span  class="bi bi-chevron-down chevron_hide"  onclick='hide_dashboard()'></span>
              </div>
              <div style="margin: auto 0px ;">
                {% if contract.status == 'DELETE'%}
                  Request for DELETION : pending validation from validator(s)
                {% endif%} 
                {% if contract.status == 'NEW'%}
                  Request for CREATION : pending validation from validator(s)
                {% endif%} 
                {% if contract.status == 'CHANGE'%}
                  Request for MODIFICATION : pending validation from validator(s)
                {% endif%} 
              </div>
              {% if  user.role in 'VALIDATOR'  %}
                <div style="float: right;">
                  <div style="width:100px ;float: right;" id="button" >
                    <div  class="comboTreeWrapper"  >
                      <div  class="comboTreeInputWrapper"  >
                        <button class="comboTreeInputBox" style="width:100px; margin:2px;background-color:transparent">ACTION</button>
                      </div>
                      <div  class="comboTreeDropDownContainer action_button" id="dropdown_contract" >
                        <form action="{% url 'response_validator' %}" method="post" id="reponse_validator_form" >
                          {% csrf_token %}
                          {% if contract.status == 'DELETE'  %}
                            <li style="display: block; padding-left:0px; margin:2px"  >
                              <button type="button" class="approve_button" onclick='submit_validator_decision("approve_contract_deletion")'>Approve delition</button>
                            </li>
                            <li style="display: block; padding-left:0px; margin:2px"  >
                              <button type="button" class="reject_button" onclick='submit_validator_decision("reject_contract_deletion")'>Reject delition</button>
                            </li>
                          {% elif contract.status == 'NEW' %}
                            <li style="display: block; padding-left:0px; margin:2px"  >
                              <button type="button" class="approve_button" onclick='submit_validator_decision("approve_contract_creation")'>Approve creation</button>
                            </li>
                            <li style="display: block; padding-left:0px; margin:2px"  >
                              <button type="button" class="reject_button" onclick='submit_validator_decision("reject_contract_creation")'>Reject creation</button>
                            </li>
                          {% else %} <!--if status= Proposal-->
                            <li style="display: block; padding-left:0px; margin:2px"  >
                              <button type="button" class="approve_button" onclick='submit_validator_decision("approve_contract_modification")'>Approve modification</button>
                            </li>
                            <li style="display: block; padding-left:0px; margin:2px"  >
                              <button type="button" class="reject_button" onclick='submit_validator_decision("reject_contract_modification")'>Reject modification</button>
                            </li>
                          {% endif %}
                        
                          <input  hidden name="reponse_validator" id="reponse_validator" >
                          <input hidden  name="contract_id" value= "{% if contract.status == 'PROPOSAL' %} {{inital_contract_id}} {% else %}{{contract.id}}{%endif%}" >
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>

            <div class="form_dashboard form_dashboard_fixed"   > 
              <table>
                <tr>
                  <td style="width:150px"> <!--type-->
                    <b>Contract Type:</b>
                  </td>
                  <td style="width:25vw; min-width:150px"> 
                    <span class="form_dashboard_content">{{contract_PENDING_VALIDATION.contract_type}}</span>
                  </td>
                  <td style="width:160px"> <!--Currency-->
                    <b style=" margin-left:10px">Currency:</b>
                  </td>
                  <td>
                    <span class="form_dashboard_content" >{{contract_PENDING_VALIDATION.contract_currency}}</span>
                  </td>
                  <td style="display: none;"> <!-- Div via-->
                    <span class="form_dashboard_content" >{{ contract_PENDING_VALIDATION.division_via.division_id }}</span>
                  </td>
                </tr>
                <tr>
                  <td > <!--Name-->
                    <b>Contract Name:</b>
                  </td>
                  <td > 
                    <span class="form_dashboard_content">{{contract_PENDING_VALIDATION.contract_name}}</span>
                  </td>
                  <td > <!--periodicity-->
                    <b style=" margin-left:10px">Payment Periodicity:</b>
                  </td>
                  <td>
                    <span class="form_dashboard_content" >{{contract_PENDING_VALIDATION.payment_periodicity.periodicity}}</span>  
                  </td>
                </tr>
                <tr>
                  <td > <!--Gald Div list-->
                    <b >Division:</b>
                  </td>
                  <td>
                      <span class="form_dashboard_content" >{{ contract_PENDING_VALIDATION.division.division_id }}</span>
                  </td>

                  <td > <!--payment terms-->
                    <b style=" margin-left:10px">Payment terms (days):</b>
                  </td>
                  <td ><!--payment terms-->
                    <span class="form_dashboard_content" >{{contract_PENDING_VALIDATION.payment_terms}}</span> 
                  </td>
                </tr>
                <tr>
                  <td > <!--pay/REC-->
                    <b>Pay/REC:</b>
                  </td>
                  <td >
                    <span class="form_dashboard_content" >{{ contract_PENDING_VALIDATION.transaction_direction }}</span>
                  </td>
                  <td > <!--Brand list-->
                    <b style=" margin-left:10px">Brand:</b>
                  </td>
                  <td><!--Brand list-->
                    <span class="form_dashboard_content" >{{contract_PENDING_VALIDATION.m3_brand.brand_name}}</span> 
                  </td>
                </tr>

              </table> 

            </div>
          </div>
          <!---------------------------Icon------------------------------------------------->
            <div class="horizontal-bar-contract">
              <div class="icon icon_all" onclick="change_tab('all','pending_validation')">
                <div  class="icon-circle" style="background-Color : red; color:red;border:solid 2px red">
                  <span  class="bi bi-eye-fill "  style="font-size:30px; color:white"></span>  
                </div>
                <div style="text-align: center;">All</div>
              </div>
              <div class="icon icon_rule" onclick="change_tab('rule','pending_validation')">
                <div  class="icon-circle">
                  <span  class="bi bi-journal-check "  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Rules</div>
              </div>
              <div class="icon icon_milestone" onclick="change_tab('milestone','pending_validation')">
                <div  class="icon-circle">
                  <span  class="bi bi-list-check "  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Milestones</div>
              </div>
              <div class="icon icon_beneficiary" onclick="change_tab('beneficiary','pending_validation')">
                <div  class="icon-circle">
                  <span  class="bi bi-people"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Partners</div>
              </div>
              <div class="icon icon_mini_guar" onclick="change_tab('mini_guar','pending_validation')">
                <div  class="icon-circle">
                  <span  class="bi bi-life-preserver"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">Guarantee</div>
              </div>
              <div class="icon icon_attachement" onclick="change_tab('attachement','pending_validation')">
                <div  class="icon-circle">
                  <span  class="bi bi-paperclip"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">attachement</div>
              </div>
              <div class="icon icon_sales_breakdown" onclick="change_tab('sales_breakdown','pending_validation')">
                <div  class="icon-circle">
                  <span  class="bi bi-file-earmark-arrow-down"  style="font-size:30px"></span>  
                </div>
                <div style="text-align: center;">report</div>
              </div>
            </div>
            <div style="padding:20px 0px 0px 20px">
              <!----------------------------Rule table--------------------------------------> 
                {% if rule_list_PENDING_VALIDATION %} 
                  <div class="chevron" >
                    <span style="display: none;" class="bi bi-chevron-right" id="unhide_PENDING_VALIDATION_rule" onclick='unhide_table("PENDING_VALIDATION_rule")'></span>
                    <span  class="bi bi-chevron-down " id="hide_PENDING_VALIDATION_rule" onclick='hide_table("PENDING_VALIDATION_rule")'></span>
                    <h5 >Rules</h5>
                  </div>
                  <div id="PENDING_VALIDATION_rule" class="content rule">
                  <!----------------------------SALES--------------------------------------> 
                    {% if rule_SALES_list_PENDING_VALIDATION != 0 %}
                      {% if contract_PENDING_VALIDATION.contract_type.name == "MARGIN_ADJ" %}
                        <span >SALES</span>
                      {% endif %}
                      <div  style="width:100% ;display: block" class="content rule">
                        <table  class="table table-striped table-sm"   style="width:100%">
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width:100px">Period from</th>
                              <th style="width:100px">Period to</th>
                              <th ></th>
                            </tr>
                          </thead>   
                          <tbody >
                            {% for rule in rule_list_PENDING_VALIDATION %}
                              {% if rule.rule_type == "SALES" %}
                                <tr> 
                                  <td > <!--Formulation  -->
                                    <span>  {{ rule.formulation.all|join:" ," }}</span>
                                  </td>
                    
                                  <td> <!--Country-->
                                    <span>
                                      {% if rule.country_incl_excl == "EXCLUDE" %}All{% if rule.country_list != "---" %} except : {{ rule.country_list }}{% endif %}{% else %}{{ rule.country_list }}{% endif %}
                                    </span>
                                  </td>           
                    
                                  <td><!--Date From-->
                                    <span>{{rule.period_from|date:"Y-m-d"}}</span>
                                  </td>
                        
                                  <td><!--Date To-->
                                    <span>{{rule.period_to|date:"Y-m-d"}}</span>
                                  </td>
                    
                                  <td ><!-- Delete Button-->
                                  </td>
                                </tr>
                              {% endif %}    
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% endif %}
                  <!----------------------------COGS--------------------------------------> 
                    {% if rule_COGS_list_PENDING_VALIDATION != 0 %}
                      {% if contract_PENDING_VALIDATION.contract_type.name == "MARGIN_ADJ" %}
                        <span >COGS</span>
                      {% endif %}
                      <div  style="width:100% ;display: block" class="content rule" >
                        <table  class="table table-striped table-sm " style="width:100%">
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width:100px">Period from</th>
                              <th style="width:100px">Period to</th>
                              <th >COGS per unit</th>
                              <th ></th>
                            </tr>
                          </thead>
                          
                          <tbody >
                            {% for rule in rule_list_PENDING_VALIDATION %}
                              {% if rule.rule_type == "COGS" %}
                                <tr> 
                                  <td > <!--Formulation  -->
                                    <span>  {{ rule.formulation.all|join:" ," }}</span>
                                  </td>
                    
                                  <td> <!--Country-->
                                    <span>
                                      {% if rule.country_incl_excl == "EXCLUDE" %}All{% if rule.country_list != "---" %} except : {{ rule.country_list }}{% endif %}{% else %}{{ rule.country_list }}{% endif %}
                                    </span>
                                  </td>           
                    
                                  <td><!--Date From-->
                                    <span>{{rule.period_from|date:"Y-m-d"}}</span>
                                  </td>
                        
                                  <td><!--Date To-->
                                    <span>{{rule.period_to|date:"Y-m-d"}}</span>
                                  </td>
                                  <td {% if rule.tranche_type == 'YES' or rule.field_type == 'RATE' %} hidden {% endif  %} style="display:grid; grid-template-columns: auto auto"><!-- Qty amount-->
                                    <span>{{rule.qty_value|floatformat:"-3g"}} {{rule.qty_value_currency}}</span>
                                  </td>
                                  <td ><!-- Delete Button-->
                                  </td>
                                </tr> 
                              {% endif %}
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% endif %}
                  <!----------------------------ROYALTY--------------------------------------> 
                    {% if rule_ROYALTY_list_PENDING_VALIDATION != 0 %}
                      {% if contract_PENDING_VALIDATION.contract_type.name == "MARGIN_ADJ" %}
                        <span >ROYALTY</span>
                      {% endif %}
                      <div  style="width:100% ;display: block" class="content rule" >
                        <table  class="table table-striped table-sm  "  style="width:100%;">
                          <thead>
                            <tr >
                              <th style="width:15vw; min-width:150px">Formulation</th>
                              <th style="width:15vw; min-width:150px">Country</th>
                              <th style="width: 100px">Period from</th>
                              <th style="width:100px">Period to</th>
                              <th>Royalty</th>
                              <th ></th>
                            </tr>
                          </thead>
                          <tbody >
                            {% for rule in rule_list_PENDING_VALIDATION %}
                              {% if rule.rule_type == "ROYALTY" %}
                                <tr> 
                                  <td><span>{{rule.formulation.all|join:" ,"}}</span></td>
                                  <td> <!--Country-->
                                    <span>
                                      {% if rule.country_incl_excl == "EXCLUDE" %}All{% if rule.country_list != "---" %} except : {{ rule.country_list }}{% endif %}{% else %}{{ rule.country_list }}{% endif %}
                                    </span>
                                  </td>

                                  <td><!--Date From-->
                                    <span>{{rule.period_from|date:"Y-m-d"}}</span>
                                  </td>

                                  <td><!--Date To-->
                                    <span>{{rule.period_to|date:"Y-m-d"}}</span>
                                  </td>

                                  <td {% if rule.tranche_type == 'YES' or rule.field_type == 'QTY' %}hidden {% endif  %}><!-- Rate percentage-->
                                    <span>{{rule.rate_value|floatformat:2}}%</span>
                                  </td>

                                  <td {% if rule.tranche_type == 'NO' or rule.field_type == 'QTY' %}hidden {% endif  %}><!--table for tranches-->
                                    <table class="table table-striped " style="width: 320px;background-color:white">
                                      <thead>
                                        <tr>
                                          <th style="width:120px">from</th>
                                          <th style="width:120px">to ({{rule.tranche_currency}})</th>
                                          <th style="width:80px">rate</th>
                                          <th></th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {% for tranche in tranche_list_PENDING_VALIDATION%}
                                          {% if tranche.rule == rule %}
                                          <tr>
                                            <td>{{tranche.from_amount|floatformat:"-3g"}}</td>
                                            <td >
                                              <span>{% if tranche.to_amount == 0 %}infinity{% else %}{{tranche.to_amount|floatformat:"-3g"}}{% endif %}</span>
                                            </td>
                                            <td>
                                              <span>{{tranche.percentage}}%</span>
                                            </td>
                                            <td></tr>
                                          {% endif %}
                                        {% endfor %}
                                      <tbody>
                                    </table>
                                  </td>

                                  <td {% if rule.tranche_type == 'YES' or rule.field_type == 'RATE' %} hidden {% endif  %} style="display:grid; grid-template-columns: auto auto"><!-- Qty amount-->
                                    <span>{{rule.qty_value|floatformat:"-3g"}} {{rule.qty_value_currency}} per unit sold</span>
                                  </td>
                                  
                                  <td {% if rule.tranche_type == 'NO' or rule.field_type == 'RATE' %}hidden {% endif  %}><!-- Tranche for qty : not available-->
                                    <span>functionality not activated</span>
                                  </td>

                                  <td></td><!-- Delete Button-->
                                  
                                </tr>   
                              {% endif %}  
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% endif %}
                  <!----------------------------MARGIN--------------------------------------> 
                  {% if rule_MARGIN_list_PENDING_VALIDATION != 0 %}
                    {% if contract_PENDING_VALIDATION.contract_type.name == "MARGIN_ADJ" %}
                      <span >MARGIN</span>
                    {% endif %}
                    <div  style="width:100% ;display: block" class="content rule">
                      <table  class="table table-striped table-sm  " style="width:100%">
                        <thead>
                          <tr >
                            <th style="width:15vw; min-width:150px">Formulation</th>
                            <th style="width:15vw; min-width:150px">Country</th>
                            <th style="width:100px">Period from</th>
                            <th style="width:100px">Period to</th>
                            <th >Margin</th>
                            <th ></th>
                          </tr>
                        </thead>
                        <tbody >
                          {% for rule in rule_list_PENDING_VALIDATION %}
                            {% if rule.rule_type == "MARGIN" %}
                              <tr> 
                                <td> <!--Formulation-->
                                  <span>  {{ rule.formulation.all|join:" ," }}</span>
                                </td>
                                <td> <!--Country-->
                                  <span>
                                    {% if rule.country_incl_excl == "EXCLUDE" %}All{% if rule.country_list != "---" %} except : {{ rule.country_list }}{% endif %}{% else %}{{ rule.country_list }}{% endif %}
                                  </span>
                                </td>
                                <td><!--Date From-->
                                  <span>{{rule.period_from|date:"Y-m-d"}}</span>
                                </td>
                                <td><!--Date To-->
                                  <span>{{rule.period_to|date:"Y-m-d"}}</span>
                                </td>
                                <td {% if rule.tranche_type == 'YES' or rule.field_type == 'QTY' %}hidden {% endif  %}><!-- Rate percentage-->
                                  <span>{{rule.rate_value|floatformat:2}}%</span>
                                </td>
                                <td {% if rule.tranche_type == 'NO' or rule.field_type == 'QTY' %}hidden {% endif  %}><!--table for tranches-->
                                  <table class="table table-striped " style="width: 320px;background-color:white">
                                    <thead>
                                      <tr>
                                        <th style="width:120px">from</th>
                                        <th style="width:120px">to ({{rule.tranche_currency}})</th>
                                        <th style="width:80px">rate</th>
                                        <th></th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {% for tranche in tranche_list_PENDING_VALIDATION %}
                                        {% if tranche.rule == rule %}
                                        <tr>
                                          <td>{{tranche.from_amount|floatformat:"-3g"}}</td>
                                          <td >
                                            <span>{% if tranche.to_amount == 0 %}infinity{% else %}{{tranche.to_amount|floatformat:"-3g"}}{% endif %}</span>
                                          </td>
                                          <td>
                                            <span>{{tranche.percentage}}%</span>
                                          </td>
                                          <td></td>
                                        </tr>
                                        {% endif %}
                                      {% endfor %}
                                    <tbody>
                                  </table>
                                </td>
                                <td ><!-- Delete Button-->
                                </td>
                              </tr>  
                            {% endif %}     
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% endif %}
                  </div>
                {% endif %}
            
              <!----------------------------------Milestone payment-------------------------->
                {% if milestone_list_PENDING_VALIDATION %}
                  <div class="chevron" >
                    <span style="display: none;" class="bi bi-chevron-right" id="unhide_PENDING_VALIDATION_milestone" onclick='unhide_table("PENDING_VALIDATION_milestone")'></span>
                    <span  class="bi bi-chevron-down" id="hide_PENDING_VALIDATION_milestone" onclick='hide_table("PENDING_VALIDATION_milestone")'></span>
                    <h5 >Milestones</h5>
                  </div>
                  <div  style="width:100% ;display: block" class="content milestone" id="PENDING_VALIDATION_milestone">
                    <table  class="table table-striped table-sm "  style="max-width: 1000px">
                      <thead>
                        <tr >
                          <th>Name</th>
                          <th>Amount</th>
                          <th>Booked</th>
                          <th>Market</th>
                          <th>Booking date</th>
                          <th>Payment date</th>
                          <th style=" height: 45px;"></th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for milestone in milestone_list_PENDING_VALIDATION %}
                          <tr >
                            <td style="min-width:100px"><!--Name-->
                              <span style="width:100%;background-color: transparent;border-style: None;" >{{milestone.name}}</span>
                            </td>
                            <td style="min-width:100px"><!--Amount-->
                              <span  style="width:100%;background-color: transparent;border-style: None;" >{{milestone.amount|floatformat:"-3g"}}</span>
                              <span  style="width:100%;background-color: transparent;border-style: None;" >{{milestone.currency}}</span>
                            </td>
                            <td style="min-width:60px"><!--booked-->
                              <span  style="width:100%;background-color: transparent;border-style: None;" >{{milestone.booked}}</span>
                            </td>
                            <td  style="width:80px"><!--Market-->
                              <span {% if milestone.booked == "NO" %} hidden {% endif %} style=" background-color:transparent; border:None ;width:100%">{{milestone.market}}</span>
                            </td>
                            <td style="width:140px"><!--Booking date-->
                              <span {% if milestone.booked == "NO" %} hidden {% endif %} style=" background-color:transparent; border:None ;width:100%">{{milestone.booking_date|date:"Y-m-d"}}</span>
                            </td>
                            <td style="width:140px"><!--Payment date-->
                              <span {% if milestone.booked == "NO" %} hidden {% endif %} style=" background-color:transparent; border:None ;width:100%">{{milestone.payment_date|date:"Y-m-d"}}</span>
                            </td>
                            <td ><!--Button-->
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}


              <!----------------------------Beneficiary table-------------------------------->
                {% if contract_partner_list_PENDING_VALIDATION %}
                  <div class="chevron" >
                    <span style="display: none;" class="bi bi-chevron-right" id="unhide_PENDING_VALIDATION_beneficiary" onclick='unhide_table("PENDING_VALIDATION_beneficiary")'></span>
                    <span  class="bi bi-chevron-down" id="hide_PENDING_VALIDATION_beneficiary" onclick='hide_table("PENDING_VALIDATION_beneficiary")'></span>
                    <h5 >Beneficiaries</h5>
                  </div>
                  <div  style="width:100% ;display: block" class="content beneficiary" id="PENDING_VALIDATION_beneficiary">
                    <table   class="table table-striped table-sm "  style="max-width: 500px">
                      <thead>
                        <tr >
                          <th > Name</th>
                          <th style="width: 80px">%</th>
                          <th style="width: 50px; ">
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for cp in contract_partner_list_PENDING_VALIDATION%}
                          <tr >
                            <td ><!--Partner-->
                              <span>{{cp.partner.partner_name}}</span>
                            </td>
                            <td><!--percentage-->
                              <span>{{cp.percentage}} %</span>
                            </td>
                            <td ><!--Button-->
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}

              <!----------------------------------Mini_guar---------------------------------->
                {% if contract_PENDING_VALIDATION.minimum_guar_amount != 0  %}
                  <div class="chevron" >
                    <span style="display: none;" class="bi bi-chevron-right" id="unhide_PENDING_VALIDATION_mini_guar" onclick='unhide_table("PENDING_VALIDATION_mini_guar")'></span>
                    <span  class="bi bi-chevron-down" id="hide_PENDING_VALIDATION_mini_guar" onclick='hide_table("PENDING_VALIDATION_mini_guar")'></span>
                    <h5 >Minimum Guarantee</h5>
                  </div>
                  <div   class="content mini_guar" style="display: block" id="PENDING_VALIDATION_mini_guar">
                    <div style=" display:grid;grid-template-columns: 320px 50px auto;margin-bottom:10px; width: 578px;">
                      <span>A minimum amount has to be paid/rec every year:</span>
                      <span>{{contract_PENDING_VALIDATION.mini_gar_status}}</span>
                    </div>  

                    <table  class="table table-striped table-sm"  style="max-width: 500px  " id="mini_table" {% if 'NO' == contract.mini_gar_status  %} hidden {% endif %} id="head_table" >
                      <thead>
                        <tr  >
                          <th ><span>Amount</span></th>
                          <th><span>Country to allocate</span></th>
                          <th ><span>From</span></th>
                          <th ><span>To</span></th>
                        </tr>
                      </thead>
                      <tbody >
                        <tr >
                          <td ><!--Amount-->
                            <span>{{contract_PENDING_VALIDATION.minimum_guar_amount|default_if_none:""|floatformat:"-3g"}} {{contract_PENDING_VALIDATION.contract_currency}}</span>
                          </td>
                          <td ><!--Country-->
                            <span>{{contract_PENDING_VALIDATION.minimum_guar_remaining_allocation_country.country_id}}</span>
                          </td>
                          <td><!--Date From-->
                            <span>{{ contract_PENDING_VALIDATION.mini_gar_from }}</span>
                          </td>
                          <td><!--Date To-->
                            <span>{{ contract_PENDING_VALIDATION.mini_gar_to }}</span>
                          </td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>  
                {% endif %}
              <!----------------------------Contract saved in PDF---------------------------->
                {% if attachement_list_PENDING_VALIDATION %}
                  <div class="chevron" >
                    <span style="display: none;" class="bi bi-chevron-right" id="unhide_PENDING_VALIDATION_attachement" onclick='unhide_table("PENDING_VALIDATION_attachement")'></span>
                    <span  class="bi bi-chevron-down" id="hide_PENDING_VALIDATION_attachement" onclick='hide_table("PENDING_VALIDATION_attachement")'></span>
                    <h5 >Supporting document(s)</h5>
                  </div>
                  <div  class="content attachement" style="display: block" id="PENDING_VALIDATION_attachement" >
                    <table  class="table table-striped table-sm "  style="max-width: 500px">
                      <tbody>
                        {% for a in attachement_list_PENDING_VALIDATION %}
                          <tr >
                            <td ><!--File Name-->
                              <a href='{{a.upload.url}}' ><span class="fname"  >{{a.name}}</span></a>
                            </td>
                            <td ><!--Button-->
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
              <!----------------------------------Sales_breakdown_per_contract--------------->
                {% if sbd_contract_PENDING_VALIDATION %}
                  <div class="chevron" >
                    <span style="display: none;" class="bi bi-chevron-right" id="unhide_PENDING_VALIDATION_sales_breakdown" onclick='unhide_table("PENDING_VALIDATION_sales_breakdown")'></span>
                    <span  class="bi bi-chevron-down" id="hide_PENDING_VALIDATION_sales_breakdown" onclick='hide_table("PENDING_VALIDATION_sales_breakdown")'></span>
                    <h5 >Breakdown of sales in invoice reporting</h5>
                  </div>
                  <div  class="content sales_breakdown" style="display: block" id="PENDING_VALIDATION_sales_breakdown"  >
                    <table  class="table table-striped table-sm"  style="max-width: 500px">
                      <thead>
                        <tr >
                          <th hidden></th>
                          <th>In import file</th>
                          <th>In contract report</th>
                          <th style="width: 30px">
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in sbd_PENDING_VALIDATION %}
                          {% for sbd_contract in sbd_contract_PENDING_VALIDATION%}
                            {% if sbd_contract.sales_breakdown_item == item %}
                              <tr> 
                                <td hidden>{{item.id}}</td>
                                <td >{{item.sales_breakdown_definition}}</td>
                                <td colspan="2" >
                                  <span>
                                      {{sbd_contract.sales_breakdown_contract_definition}}
                                  </span>
                                </td>
                              </tr>
                            {% endif %}
                          {% endfor %}
                        {% endfor%}
                      </tbody>

                    </table>
                  </div>
                {% endif %}
            </div> 
        </div>
      {% endif%}

      
{% load static %}
<script src="{% static 'royalty_app/contracts/rules.js'%}"></script>
<link rel="stylesheet" href="{% static 'royalty_app/style.css'%}">

<script src="{% static 'royalty_app/easy-number-separator.js'%}"></script>

{% endblock %}


  